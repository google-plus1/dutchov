<script>
/* ------------------------- Storage keys / defaults ------------------------- */
const STORAGE_USERS = 'erlc_users_v3';
const STORAGE_ROUTES = 'erlc_routes_v3';
const STORAGE_LOGS = 'erlc_logs_v3';
const STORAGE_ACTIVE = 'erlc_activeDrivers_v3';
const STORAGE_STRIKES = 'erlc_strikes_v3';
const STORAGE_ROUTE_OWNERS = 'erlc_routeOwners_v3';

const defaultUsers = {
  "pwatg123admin": {pw:"utrechtov20092025", admin:true},
  "Roidkyadmin": {pw:"Mohamed4obai", admin:true},
  "Roidky": {pw:"Mohamed4obai", admin:false},
  "pwatg123": {pw:"utrechtov20092025", admin:false},
  "Ilias123": {pw:"Pass123", admin:false},
  "milandepro7": {pw:"Utrechtov20702025", admin:false},
  "blobvisje.": {pw:"pass123", admin:false}
};

const defaultRoutes = {
  "Lijn 6": {freq:10, stops:["Spawn","Fire Department","Central Park","P+R Transferium","Farms","Highrock"]},
  "Lijn 7 Shuttlebus": {freq:10, stops:["Spawn","Fire Department","Central Park","Hostpital"]},
  "Lijn 8 Shuttlebus": {freq:10, stops:["Spawn","Repair shop","P+R Transferium"]},
  "Lijn 9": {freq:10, stops:["Spawn","Chinatown","Fire Department","Central Park","Hospital","Farms","Highrock","Springfield"]},
  "FastLine": {freq:8, stops:["Springfield","River City"]}
};

/* ------------------------- Storage helpers ------------------------- */
function save(key, value){ localStorage.setItem(key, JSON.stringify(value)); }
function load(key, fallback){ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }

let USERS = load(STORAGE_USERS, defaultUsers);
let ROUTES = load(STORAGE_ROUTES, null);
if(!ROUTES){
  ROUTES = JSON.parse(JSON.stringify(defaultRoutes));
  for(const name in defaultRoutes){
    const rev = name + " 2";
    if(!ROUTES[rev]) ROUTES[rev] = {freq: defaultRoutes[name].freq, stops:[...defaultRoutes[name].stops].reverse()};
  }
  save(STORAGE_ROUTES, ROUTES);
}
let LOGS = load(STORAGE_LOGS, []);
let ACTIVE_DRIVERS = load(STORAGE_ACTIVE, []);
let STRIKES = load(STORAGE_STRIKES, {});
let ROUTE_OWNERS = load(STORAGE_ROUTE_OWNERS, {});

/* ------------------------- DOM elements ------------------------- */
const usernameEl = document.getElementById('username');
const passwordEl = document.getElementById('password');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const loginMsg = document.getElementById('loginMsg');
const driverControls = document.getElementById('driverControls');
const lineSelect = document.getElementById('lineSelect');
const confirmBtn = document.getElementById('confirmBtn');
const reverseBtn = document.getElementById('reverseBtn');
const currentTimeEl = document.getElementById('currentTime');
const nextDepartureEl = document.getElementById('nextDeparture');
const countdownEl = document.getElementById('countdown');
const stationControls = document.getElementById('stationControls');
const departBtn = document.getElementById('departBtn');
const nextBtn = document.getElementById('nextBtn');
const endBtn = document.getElementById('endBtn');
const currentStationEl = document.getElementById('currentStation');
const timerDisplay = document.getElementById('timerDisplay');
const statusDiv = document.getElementById('status');
const timetableCard = document.getElementById('timetableCard');
const tableTitle = document.getElementById('tableTitle');
const tableBody = document.getElementById('tableBody');
const activeDriversDiv = document.getElementById('activeDrivers');
const driversList = document.getElementById('driversList');
const userBadge = document.getElementById('userBadge');
const adminPanel = document.getElementById('adminPanel');
const routesList = document.getElementById('routesList');
const logsList = document.getElementById('logsList');
const newUsername = document.getElementById('newUsername');
const newPassword = document.getElementById('newPassword');
const createUserBtn = document.getElementById('createUserBtn');
const strikeSelect = document.getElementById('strikeSelect');
const strikeAmount = document.getElementById('strikeAmount');
const giveStrikeBtn = document.getElementById('giveStrikeBtn');
const newRouteName = document.getElementById('newRouteName');
const newRouteFreq = document.getElementById('newRouteFreq');
const newRouteStops = document.getElementById('newRouteStops');
const addRouteBtn = document.getElementById('addRouteBtn');
const refreshRoutesBtn = document.getElementById('refreshRoutesBtn');

/* ------------------------- State ------------------------- */
let CURRENT_USER = null;
let CURRENT_USER_IS_ADMIN = false;
let selectedRouteName = null;
let selectedRoute = null;
let useReverse = false;
let actualDepartureTime = null;
let currentStopIndex = 0;
let timerInterval = null;

/* ------------------------- Utilities ------------------------- */
function pad(n){ return String(n).padStart(2,'0'); }
function formatTime(d){ return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }
function formatTimeWithSeconds(d){ return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'}); }
function formatDiffSec(s){ s = Math.floor(Math.abs(s)); return `${pad(Math.floor(s/60))}:${pad(s%60)}`; }

/* ------------------------- Save helpers ------------------------- */
function saveUsersAndRefresh(){ save(STORAGE_USERS, USERS); populateAdminLists(); }
function saveRoutesAndRefresh(){ save(STORAGE_ROUTES, ROUTES); populateRoutesSelect(); populateAdminLists(); }
function saveLogsAndRefresh(){ save(STORAGE_LOGS, LOGS); renderLogs(); }
function saveActiveAndRefresh(){ save(STORAGE_ACTIVE, ACTIVE_DRIVERS); renderActiveDrivers(); }
function saveStrikesAndRefresh(){ save(STORAGE_STRIKES, STRIKES); populateAdminLists(); }
function saveRouteOwnersAndRefresh(){ save(STORAGE_ROUTE_OWNERS, ROUTE_OWNERS); }

/* ------------------------- Login / Logout ------------------------- */
loginBtn.addEventListener('click', ()=>{
  const u = usernameEl.value.trim();
  const p = passwordEl.value;
  loginMsg.textContent = '';
  if(!u||!p){ loginMsg.textContent='Enter username & password'; return; }
  const rec = USERS[u];
  if(!rec||rec.pw!==p){ loginMsg.textContent='Invalid username or password'; return; }

  CURRENT_USER = u; CURRENT_USER_IS_ADMIN = !!rec.admin;
  document.getElementById('loginSection').style.display='none';
  driverControls.style.display='block';
  logoutBtn.style.display='inline-block';
  userBadge.style.display='inline-block';
  userBadge.textContent = `${CURRENT_USER}${CURRENT_USER_IS_ADMIN?' (admin)':''}`;

  if(!ACTIVE_DRIVERS.includes(CURRENT_USER)){ ACTIVE_DRIVERS.push(CURRENT_USER); saveActiveAndRefresh(); }

  populateRoutesSelect();
  populateAdminLists();
  timetableCard.style.display='none';
  stationControls.style.display='none';
  adminPanel.style.display = CURRENT_USER_IS_ADMIN ? 'block' : 'none';
});

logoutBtn.addEventListener('click', ()=>{
  if(CURRENT_USER){
    ACTIVE_DRIVERS = ACTIVE_DRIVERS.filter(d=>d!==CURRENT_USER);
    saveActiveAndRefresh();
    for(const r in ROUTE_OWNERS){ if(ROUTE_OWNERS[r]===CURRENT_USER){ delete ROUTE_OWNERS[r]; } }
    saveRouteOwnersAndRefresh();
  }
  CURRENT_USER=null; CURRENT_USER_IS_ADMIN=false;
  document.getElementById('loginSection').style.display='block';
  driverControls.style.display='none';
  adminPanel.style.display='none';
  timetableCard.style.display='none';
  stationControls.style.display='none';
  logoutBtn.style.display='none';
  userBadge.style.display='none';
});

/* ------------------------- Active Drivers ------------------------- */
function renderActiveDrivers(){
  driversList.innerHTML = '';
  ACTIVE_DRIVERS.forEach(d=>{
    const li=document.createElement('li'); li.textContent=d; driversList.appendChild(li);
  });
  activeDriversDiv.style.display = ACTIVE_DRIVERS.length ? 'block':'none';
}

/* ------------------------- Populate Routes/Admin ------------------------- */
function populateRoutesSelect(){
  lineSelect.innerHTML='';
  Object.keys(ROUTES).sort().forEach(n=>{
    const opt=document.createElement('option'); opt.value=n; opt.textContent=n; lineSelect.appendChild(opt);
  });
  if(lineSelect.options.length) lineSelect.value=lineSelect.options[0].value;
}

function populateAdminLists(){
  routesList.innerHTML='';
  Object.keys(ROUTES).sort().forEach(name=>{
    const div=document.createElement('div'); div.style.display='flex'; div.style.justifyContent='space-between'; div.style.alignItems='center'; div.style.marginBottom='8px';
    const left=document.createElement('div');
    left.innerHTML=`<strong>${name}</strong> <div class="mutedSmall">${ROUTES[name].freq} min â€” ${ROUTES[name].stops.length} stops</div>`;
    const right=document.createElement('div');
    const delBtn=document.createElement('button'); delBtn.className='smallBtn'; delBtn.textContent='Delete';
    delBtn.addEventListener('click', ()=>{ if(!confirm(`Delete route "${name}" and its reverse?`)) return; delete ROUTES[name]; const rev = name.endsWith(' 2')? name.replace(/ 2$/,'') : name+' 2'; if(ROUTES[rev]) delete ROUTES[rev]; saveRoutesAndRefresh(); });
    right.appendChild(delBtn);
    div.appendChild(left); div.appendChild(right);
    routesList.appendChild(div);
  });

  strikeSelect.innerHTML='';
  Object.keys(USERS).sort().forEach(u=>{
    const opt=document.createElement('option'); opt.value=u; opt.textContent=u; strikeSelect.appendChild(opt);
  });

  renderLogs();
}

/* ------------------------- Logs ------------------------- */
function renderLogs(){
  logsList.innerHTML='';
  if(!LOGS.length){ logsList.textContent='No shift logs'; return; }
  LOGS.forEach((l,idx)=>{
    const wrap=document.createElement('div    wrap.className='logItem';
    const left=document.createElement('div');
    left.innerHTML=`<strong>${l.user}</strong> - ${l.route} <div class="mutedSmall">${new Date(l.time).toLocaleString()}</div>`;
    const right=document.createElement('div');
    const del=document.createElement('button'); del.className='smallBtn'; del.textContent='Delete';
    del.addEventListener('click',()=>{
      if(!confirm('Delete this log?')) return;
      LOGS.splice(idx,1);
      saveLogsAndRefresh();
    });
    right.appendChild(del);
    wrap.appendChild(left); wrap.appendChild(right);
    logsList.appendChild(wrap);
  });
}

/* ------------------------- Route ownership helpers ------------------------- */
function canLoadRoute(routeName){ return !ROUTE_OWNERS[routeName] || ROUTE_OWNERS[routeName]===CURRENT_USER; }
function reserveRoute(routeName,user){ ROUTE_OWNERS[routeName]=user; saveRouteOwnersAndRefresh(); }
function freeRoute(routeName){ if(ROUTE_OWNERS[routeName]){ delete ROUTE_OWNERS[routeName]; saveRouteOwnersAndRefresh(); } }

/* ------------------------- Depart / Next / End ------------------------- */
function startStopTimerForIndex(idx){
  clearTimer();
  updateCurrentStation(idx);
  updateTimerDisplay();
  timerInterval=setInterval(updateTimerDisplay,1000);
}
function updateCurrentStation(idx){
  const stationName = selectedRoute && selectedRoute.stops[idx]?selectedRoute.stops[idx]:'';
  currentStationEl.textContent=stationName?`Current station: ${stationName}`:'';
}
function updateTimerDisplay(){
  if(!selectedRoute || currentStopIndex>=selectedRoute.stops.length || !actualDepartureTime){
    timerDisplay.textContent='--:--'; nextBtn.disabled=true; return;
  }
  const expected = new Date(actualDepartureTime.getTime()+currentStopIndex*60000);
  const diffSec = Math.ceil((expected-new Date())/1000);
  if(diffSec>0){ timerDisplay.style.background='var(--good)'; timerDisplay.textContent=formatDiffSec(diffSec); nextBtn.disabled=diffSec>15; }
  else{ timerDisplay.style.background='var(--bad)'; timerDisplay.textContent='-'+formatDiffSec(Math.abs(diffSec)); nextBtn.disabled=false; }
}
function clearTimer(){ if(timerInterval) clearInterval(timerInterval); timerInterval=null; timerDisplay.textContent='--:--'; nextBtn.disabled=true; }
function endRoute(){
  clearTimer(); statusDiv.textContent='Route completed!';
  freeRoute(selectedRouteName);
  currentStopIndex=0; actualDepartureTime=null; currentStationEl.textContent='';
  renderDynamicTimetable(selectedRoute,null);
}

/* ------------------------- Timetable rendering ------------------------- */
function renderDynamicTimetable(route, departTime){
  tableBody.innerHTML=''; if(!route) return;
  let baseDepart = departTime ? new Date(departTime) : getNextDeparture(new Date(), route.freq);
  nextDepartureEl.textContent=formatTime(baseDepart);
  route.stops.forEach((stop,i)=>{
    const tr=document.createElement('tr');
    const tdStop=document.createElement('td'); tdStop.textContent=stop;
    const tdTime=document.createElement('td');
    const arrival=new Date(baseDepart.getTime()+i*60000);
    tdTime.textContent=formatTime(arrival);
    tr.appendChild(tdStop); tr.appendChild(tdTime);
    tableBody.appendChild(tr);
  });
}

/* ------------------------- Admin: create user / strikes / routes ------------------------- */
createUserBtn.addEventListener('click',()=>{
  const u=(newUsername.value||'').trim(); const p=newPassword.value||'';
  if(!u||!p){ alert('Provide username and password'); return; }
  if(USERS[u]){ alert('User already exists'); return; }
  USERS[u]={pw:p, admin:false}; saveUsersAndRefresh();
  newUsername.value=''; newPassword.value=''; alert(`Created user ${u}`);
});

giveStrikeBtn.addEventListener('click',()=>{
  const u=strikeSelect.value; const amt=parseInt(strikeAmount.value||'1',10);
  if(!u){ alert('Select user'); return; }
  STRIKES[u]=(STRIKES[u]||0)+amt; saveStrikesAndRefresh();
  alert(`Gave ${amt} strike(s) to ${u}. Total: ${STRIKES[u]}`);
});

addRouteBtn.addEventListener('click',()=>{
  const name=(newRouteName.value||'').trim();
  const freq=parseInt(newRouteFreq.value||'10',10);
  const stopsRaw=(newRouteStops.value||'').trim();
  if(!name||!stopsRaw){ alert('Provide route name and stops'); return; }
  const stops=stopsRaw.split(/\r?\n|,/).map(s=>s.trim()).filter(Boolean);
  if(stops.length<2){ alert('Need at least 2 stops'); return; }
  ROUTES[name]={freq:freq||10, stops}; ROUTES[name+' 2']={freq:freq||10, stops:[...stops].reverse()};
  saveRoutesAndRefresh();
  newRouteName.value=''; newRouteFreq.value=''; newRouteStops.value='';
});

refreshRoutesBtn.addEventListener('click',()=>{
  ROUTES=load(STORAGE_ROUTES, defaultRoutes); populateRoutesSelect(); populateAdminLists();
});

/* ------------------------- Init UI ------------------------- */
function initUI(){
  populateRoutesSelect(); populateAdminLists(); renderActiveDrivers(); renderLogs();
  strikeSelect.innerHTML=''; Object.keys(USERS).sort().forEach(n=>{
    const o=document.createElement('option'); o.value=n; o.textContent=n; strikeSelect.appendChild(o);
  });
}

initUI();
</script>

