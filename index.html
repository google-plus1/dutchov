<script>
/* ------------------------- Storage keys & defaults ------------------------- */
const STORAGE_ROUTES = 'erlc_routes_v2';
const STORAGE_LOGS = 'erlc_logs_v2';
const STORAGE_USERS = 'erlc_users_v2';

const defaultUsers = {
  "pwatg123admin": { pw: "utrechtov20092025", admin:true },
  "Roidkyadmin":   { pw: "Mohamed4obai", admin:true },
  "Roidky":        { pw: "Mohamed4obai", admin:false },
  "pwatg123":      { pw: "utrechtov20092025", admin:false },
  "Ilias123":      { pw: "Pass123", admin:false },
  "milandepro7":   { pw: "Utrechtov20702025", admin:false },
  "blobvisje.":    { pw: "pass123", admin:false }
};

const DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/1429903434366193734/DRdYl52p-VEVzDjyxgwxrzZR3zZvZUy-oxMAR9C82YF67iMemQdddDIu71gKl0veKdtM";

const defaultRoutes = {
  "Line A": { freq:10, stops:[ "Spawn","Chinatown","Central Park","Highrock" ] },
  "Line C": { freq:10, stops:[ "Spawn","Chinatown","Fire Department","Central Park","Hospital","Farms","Highrock","Springfield" ] },
  "FastLine": { freq:8, stops:[ "Springfield","River City" ] }
};

/* ------------------------- Storage helpers ------------------------- */
function saveRoutes(routes){ localStorage.setItem(STORAGE_ROUTES, JSON.stringify(routes)); ROUTES = routes; }
function saveUsers(users){ localStorage.setItem(STORAGE_USERS, JSON.stringify(users)); USERS = users; }
function saveLogs(logs){ localStorage.setItem(STORAGE_LOGS, JSON.stringify(logs)); LOGS = logs; }

function loadRoutes(){
  let r = localStorage.getItem(STORAGE_ROUTES);
  if(!r){
    const temp = JSON.parse(JSON.stringify(defaultRoutes));
    for(const name in defaultRoutes){
      const revName = name+" 2";
      temp[revName] = { freq: defaultRoutes[name].freq, stops:[...defaultRoutes[name].stops].reverse() };
    }
    saveRoutes(temp);
    return temp;
  }
  return JSON.parse(r);
}

function loadUsers(){
  let u = localStorage.getItem(STORAGE_USERS);
  if(!u){ saveUsers(defaultUsers); return defaultUsers; }
  return JSON.parse(u);
}

function loadLogs(){ let l = localStorage.getItem(STORAGE_LOGS); return l?JSON.parse(l):[]; }

let ROUTES = loadRoutes();
let USERS = loadUsers();
let LOGS = loadLogs();

/* ------------------------- DOM elements ------------------------- */
const usernameEl = document.getElementById('username');
const passwordEl = document.getElementById('password');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const loginMsg = document.getElementById('loginMsg');

const driverControls = document.getElementById('driverControls');
const lineSelect = document.getElementById('lineSelect');
const confirmBtn = document.getElementById('confirmBtn');
const reverseBtn = document.getElementById('reverseBtn');

const currentTime = document.getElementById('currentTime');
const nextDeparture = document.getElementById('nextDeparture');
const countdown = document.getElementById('countdown');

const stationControls = document.getElementById('stationControls');
const departBtn = document.getElementById('departBtn');
const nextBtn = document.getElementById('nextBtn');
const endBtn = document.getElementById('endBtn');
const timerDisplay = document.getElementById('timerDisplay');
const statusDiv = document.getElementById('status');

const timetableCard = document.getElementById('timetableCard');
const tableTitle = document.getElementById('tableTitle');
const tableBody = document.getElementById('tableBody');

const activeDriversDiv = document.getElementById('activeDrivers');
const driversList = document.getElementById('driversList');
const userBadge = document.getElementById('userBadge');

const adminPanel = document.getElementById('adminPanel');
const routesList = document.getElementById('routesList');
const logsList = document.getElementById('logsList');
const addRouteBtn = document.getElementById('addRouteBtn');
const newRouteName = document.getElementById('newRouteName');
const newRouteFreq = document.getElementById('newRouteFreq');
const newRouteStops = document.getElementById('newRouteStops');
const refreshRoutesBtn = document.getElementById('refreshRoutesBtn');
const clearLogsBtn = document.getElementById('clearLogsBtn');
const exportLogsBtn = document.getElementById('exportLogsBtn');

/* ------------------------- App state ------------------------- */
let CURRENT_USER = null;
let CURRENT_USER_IS_ADMIN = false;
let selectedRouteName = null;
let selectedRoute = null;
let useReverse = false;
let actualDepartureTime = null;
let currentStopIndex = 0;
let timerInterval = null;

/* ------------------------- Active Drivers ------------------------- */
let activeDrivers = [];
let activeRoutes = {}; // routeName: username

function addActiveDriver(name, route){
  if(!activeDrivers.includes(name)) activeDrivers.push(name);
  if(route) activeRoutes[route] = name;
  renderActiveDrivers();
}

function removeActiveDriver(name){
  const idx = activeDrivers.indexOf(name);
  if(idx>-1) activeDrivers.splice(idx,1);
  for(const route in activeRoutes) if(activeRoutes[route]===name) delete activeRoutes[route];
  renderActiveDrivers();
}

function renderActiveDrivers(){
  driversList.innerHTML='';
  activeDrivers.forEach(d=>{
    const li=document.createElement('li');
    li.textContent=d;
    driversList.appendChild(li);
  });
  activeDriversDiv.style.display = activeDrivers.length?'block':'none';
}

/* ------------------------- Utils ------------------------- */
function now(){ return new Date(); }
function formatTime(d){ return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }
function formatDiffSec(s){
  s = Math.floor(Math.abs(s));
  const mm = Math.floor(s/60);
  const ss = (s%60).toString().padStart(2,'0');
  return `${mm}:${ss}`;
}

/* ------------------------- Login ------------------------- */
loginBtn.addEventListener('click',()=>{
  const u = usernameEl.value.trim();
  const p = passwordEl.value;
  loginMsg.textContent='';
  if(!u||!p){ loginMsg.textContent='Enter username & password'; return; }
  const record = USERS[u];
  if(!record||record.pw!==p){ loginMsg.textContent='Invalid username or password'; return; }
  CURRENT_USER = u;
  CURRENT_USER_IS_ADMIN = record.admin;
  loginMsg.textContent='';
  document.getElementById('loginSection').style.display='none';
  driverControls.style.display='block';
  logoutBtn.style.display='inline-block';
  userBadge.style.display='inline-block';
  userBadge.textContent = `${CURRENT_USER}${CURRENT_USER_IS_ADMIN?' (admin)':''}`;
  addActiveDriver(CURRENT_USER);
  populateRoutesSelect();
  if(CURRENT_USER_IS_ADMIN){ adminPanel.style.display='block'; populateAdminRoutes(); populateLogs(); }
});

logoutBtn.addEventListener('click',()=>{
  removeActiveDriver(CURRENT_USER);
  CURRENT_USER=null;
  CURRENT_USER_IS_ADMIN=false;
  document.getElementById('loginSection').style.display='block';
  driverControls.style.display='none';
  adminPanel.style.display='none';
  timetableCard.style.display='none';
  stationControls.style.display='none';
  activeDriversDiv.style.display='none';
  logoutBtn.style.display='none';
  userBadge.style.display='none';
});

/* ------------------------- Populate Routes ------------------------- */
function populateRoutesSelect(){
  lineSelect.innerHTML='';
  Object.keys(ROUTES).sort().forEach(n=>{
    const opt=document.createElement('option');
    opt.value=n; opt.textContent=n;
    lineSelect.appendChild(opt);
  });
  if(lineSelect.options.length) lineSelect.value=lineSelect.options[0].value;
}

/* ------------------------- Confirm / Load Timetable ------------------------- */
confirmBtn.addEventListener('click',()=>{
  if(!lineSelect.value) return;
  const route = lineSelect.value;
  if(activeRoutes[route] && activeRoutes[route]!==CURRENT_USER){
    alert(`Route ${route} is already driven by ${activeRoutes[route]}`);
    return;
  }
  selectedRouteName = route;
  useReverse=false;
  loadSelectedRoute();
});

/* ------------------------- Reverse ------------------------- */
reverseBtn.addEventListener('click',()=>{
  if(!selectedRouteName) return;
  useReverse = !useReverse;
  loadSelectedRoute();
});

/* ------------------------- Load Route ------------------------- */
function loadSelectedRoute(){
  if(!selectedRouteName) return;
  let name = selectedRouteName;
  selectedRoute = ROUTES[name];
  if(useReverse){
    const revName = name.endsWith(' 2')? name.replace(/ 2$/,'') : name+' 2';
    if(ROUTES[revName]){ selectedRoute=ROUTES[revName]; name=revName; }
  }
  if(!selectedRoute) return;

  // Compute next departure based on frequency
  const freqMin = selectedRoute.freq;
  const nowTime = new Date();
  let nextDep = new Date();
  nextDep.setSeconds(0); nextDep.setMilliseconds(0);
  const minute = nowTime.getMinutes();
  nextDep.setMinutes(minute + (freqMin - (minute%freqMin)));

  actualDepartureTime = nextDep;
  renderDynamicTimetable(selectedRoute, actualDepartureTime);

  tableTitle.textContent = name;
  timetableCard.style.display='block';
  stationControls.style.display='block';

  updateCountdown();
  if(timerInterval) clearInterval(timerInterval);
}

/* ------------------------- Dynamic Timetable ------------------------- */
function renderDynamicTimetable(route, departTime){
  tableBody.innerHTML='';
  route.stops.forEach((stop,i)=>{
    const tr=document.createElement('tr');
    const tdStop=document.createElement('td'); tdStop.textContent = stop; tr.appendChild(tdStop);
    const tdTime=document.createElement('td');
    tdTime.textContent = departTime? formatTime(new Date(departTime.getTime() + i*60000)):'--:--';
    tr.appendChild(tdTime);
    tableBody.appendChild(tr);
  });
}

/* ------------------------- Countdown ------------------------- */
function updateCountdown(){
  if(!actualDepartureTime) return;
  const interval = setInterval(()=>{
    const diffSec = Math.floor((actualDepartureTime - new Date())/1000);
    if(diffSec<=0){ countdown.textContent='00:00'; clearInterval(interval); return; }
    const mm = Math.floor(diffSec/60).toString().padStart(2,'0');
    const ss = (diffSec%60).toString().padStart(2,'0');
    countdown.textContent = `${mm}:${ss}`;
  },1000);
}

/* ------------------------- Depart & Timer ------------------------- */
departBtn.addEventListener('click',()=>{
  if(!selectedRoute) return;
  currentStopIndex=0;
  actualDepartureTime = new Date(actualDepartureTime); // depart now
  logShift(CURRENT_USER, tableTitle.textContent);
  startStopTimerForIndex(currentStopIndex);
  statusDiv.textContent = `Departed: ${selectedRoute.stops[currentStopIndex]}`;
});

nextBtn.addEventListener('click',()=>{
  if(!selectedRoute || !actualDepartureTime) return;
  const expected = new Date(actualDepartureTime.getTime() + currentStopIndex*60000);
  const secRemaining = Math.ceil((expected-new Date())/1000);
  if(secRemaining>15){
    statusDiv.textContent=`Next Station only in last 15s before arrival (${secRemaining}s left)`; return;
  }
  const diff = Math.floor((new Date() - expected)/1000);
  statusDiv.innerHTML= diff<=0? `<span class="ok">On Time ✅</span> &nbsp;(${formatDiffSec(Math.abs(diff))})`
                             : `<span class="danger">Late ❌</span> &nbsp;(-${formatDiffSec(diff)})`;
  currentStopIndex++;
  if(currentStopIndex>=selectedRoute.stops.length){ endRoute(); return; }
  startStopTimerForIndex(currentStopIndex);
});

endBtn.addEventListener('click',endRoute);

function startStopTimerForIndex(idx){
  if(timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(updateTimerDisplay,1000);
  updateTimerDisplay();
}

function updateTimerDisplay(){
  if(!selectedRoute || currentStopIndex>=selectedRoute.stops.length || !actualDepartureTime){
    timerDisplay.textContent='--:--'; nextBtn.disabled=true; return;
  }
  const expected = new Date(actualDepartureTime.getTime() + currentStopIndex*60000);
  const diffSec = Math.ceil((expected - new Date())/1000);
  if(diffSec>0){ timerDisplay.style.background='var(--good)'; timerDisplay.textContent=formatDiffSec(diffSec); nextBtn.disabled=diffSec>15; }
  else{ timerDisplay.style.background='var(--bad)'; timerDisplay.textContent='-'+formatDiffSec(Math.abs(diffSec)); nextBtn.disabled=false; }
}

function endRoute(){
  if(timerInterval) clearInterval(timerInterval);
  timerDisplay.textContent='--:--';
  currentStopIndex=0;
  actualDepartureTime=null;
  statusDiv.textContent='Route completed!';
  renderDynamicTimetable(selectedRoute, null);
  if(selectedRouteName) delete activeRoutes[selectedRouteName];
}

/* ------------------------- Shift Logs ------------------------- */
function logShift(user, routeName){
  const entry = {user, route:routeName, departTime:new Date().toISOString()};
  LOGS.unshift(entry);
  saveLogs(LOGS);
  sendShiftLogToDiscord(user, routeName, new Date());
  if(CURRENT_USER_IS_ADMIN) populateLogs();
}

function sendShiftLogToDiscord(username, routeName, departTime){
  const message = {
    embeds: [{
      title:"🚌 New Shift Started",
      color:0x00ff00,
      fields:[
        {name:"Driver", value:username, inline:true},
        {name:"Route", value:routeName, inline:true},
        {name:"Departed At", value:departTime.toLocaleString(), inline:false}
      ],
      timestamp: new Date().toISOString()
    }]
  };
  fetch(DISCORD_WEBHOOK_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(message)
  }).catch(err=>console.error("Discord log failed:",err));
}

function populateLogs(){
  logsList.innerHTML='';
  if(!LOGS.length){ logsList.textContent='No shift logs yet'; return; }
  LOGS.forEach((l,idx)=>{
    const div=document.createElement('div'); div.className='logItem';
    const left=document.createElement('div');
    left.innerHTML=`<strong>${l.user}</strong> - ${l.route} <div class="mutedSmall">${new Date(l.departTime).toLocaleString()}</div>`;
    const right=document.createElement('div');
    const del=document.createElement('button'); del.className='smallBtn'; del.textContent='Delete';
    del.addEventListener('click',()=>{ if(!confirm('Delete this log?')) return; LOGS.splice(idx,1); saveLogs(LOGS); populateLogs(); });
    right.appendChild(del);
    div.appendChild(left); div.appendChild(right);
    logsList.appendChild(div);
  });
}

/* ------------------------- Admin Routes ------------------------- */
function populateAdminRoutes(){
  routesList.innerHTML='';
  Object.keys(ROUTES).sort().forEach(n=>{
    const div=document.createElement('div');
    div.style.display='flex'; div.style.justifyContent='space-between'; div.style.alignItems='center'; div.style.marginBottom='8px';
    const left=document.createElement('div'); left.innerHTML=`<strong>${n}</strong> <div class="mutedSmall">${ROUTES[n].freq} min — ${ROUTES[n].stops.length} stops</div>`;
    const right=document.createElement('div');
    const delBtn=document.createElement('button'); delBtn.className='smallBtn'; delBtn.textContent='Delete';
    delBtn.addEventListener('click',()=>{ if(!confirm(`Delete route "${n}" and reverse?`)) return; deleteRouteAndReverse(n); populateAdminRoutes(); populateRoutesSelect(); });
    right.appendChild(delBtn);
    div.appendChild(left); div.appendChild(right);
    routesList.appendChild(div);
  });
}

addRouteBtn.addEventListener('click',()=>{
  const name=newRouteName.value.trim();
  const freq=parseInt(newRouteFreq.value.trim());
  const stops=newRouteStops.value.split(/\n|,/).map(s=>s.trim()).filter(Boolean);
  if(!name||!freq||stops.length<2){ alert('Fill name, freq and at least 2 stops'); return; }
  ROUTES[name]={freq,stops};
  ROUTES[name+' 2']={freq,stops:[...stops].reverse()};
  saveRoutes(ROUTES); populateAdminRoutes(); populateRoutesSelect();
  newRouteName.value=''; newRouteFreq.value=''; newRouteStops.value='';
});

refreshRoutesBtn.addEventListener('click',populateAdminRoutes);
clearLogsBtn.addEventListener('click',()=>{ if(confirm('Clear all logs?')){ LOGS=[]; saveLogs(LOGS); populateLogs(); }});
exportLogsBtn.addEventListener('click',()=>{
  const data=JSON.stringify(LOGS,null,2);
  const blob=new Blob([data],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='shift_logs.json'; a.click();
