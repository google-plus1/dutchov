<script>
/* -------------------------
   Storage helpers & init
------------------------- */
const STORAGE_ROUTES = 'erlc_routes_v1';
const STORAGE_LOGS = 'erlc_logs_v1';
const STORAGE_USERS = 'erlc_users_v1';

// default users
const defaultUsers = {
  "pwatg123admin": { pw: "utrechtov20092025", admin:true },
  "Roidkyadmin":   { pw: "Mohamed4obai", admin:true },
  "Roidky":   { pw: "Mohamed4obai", admin:false },
  "pwatg123":   { pw: "utrechtov20092025", admin:false },
  "ilias4real.":   { pw: "OVIlias239", admin:false },
  "milandepro7":   { pw: "Utrechtov20702025", admin:false },
  "driver":   { pw: "pass123", admin:false }
};

// default routes
const defaultRoutes = {
  "Line A": { freq:10, stops:[ "Spawn","Brandweer Kazerene","Central Park","Centraal Station","Maple Valley Farms","Highrock Park" ] },
  "Event Shuttle": { freq:15, stops:[ "Spawn","Event Center" ] },
  "Line B": { freq:15, stops:[ "Central Park","Ouchard Boulevard","Ouchard Boulevard 2","Central Park","Medical Way","Maple Valley Farms","Highrock Park" ] },
  "Line C": { freq:10, stops:[ "Spawn","Chinatown","Fire Department","Central Park","Hospital","Farms","Highrock","Springfield" ] },
  "FastLine": { freq:8, stops:[ "Springfield","River City" ] },
  "Line D": { freq:10, stops:[ "Spawn","Chinatown","Fire Department","Central Park","Hospital","Farms","Highrock","Springfield" ] }
};

// storage helpers
function saveRoutes(routes){ localStorage.setItem(STORAGE_ROUTES, JSON.stringify(routes)); ROUTES = routes; }
function loadRoutes(){
  const raw = localStorage.getItem(STORAGE_ROUTES);
  if(!raw){
    const r = JSON.parse(JSON.stringify(defaultRoutes));
    for(const name of Object.keys(defaultRoutes)){
      const revName = name + " 2";
      if(!r[revName]) r[revName] = { freq: defaultRoutes[name].freq, stops: [...defaultRoutes[name].stops].slice().reverse() };
    }
    saveRoutes(r);
    return r;
  }
  return JSON.parse(raw);
}

function saveUsers(users){ localStorage.setItem(STORAGE_USERS, JSON.stringify(users)); }
function loadUsers(){
  const raw = localStorage.getItem(STORAGE_USERS);
  if(!raw){ saveUsers(defaultUsers); return defaultUsers; }
  return JSON.parse(raw);
}

function saveLogs(logs){ localStorage.setItem(STORAGE_LOGS, JSON.stringify(logs)); LOGS=logs; }
function loadLogs(){ const raw = localStorage.getItem(STORAGE_LOGS); return raw? JSON.parse(raw): []; }

// init
let ROUTES = loadRoutes();
let USERS = loadUsers();
let LOGS = loadLogs();

/* -------------------------
   DOM elements
------------------------- */
const usernameEl = document.getElementById('username');
const passwordEl = document.getElementById('password');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const loginMsg = document.getElementById('loginMsg');

const driverControls = document.getElementById('driverControls');
const lineSelect = document.getElementById('lineSelect');
const confirmBtn = document.getElementById('confirmBtn');
const reverseBtn = document.getElementById('reverseBtn');

const currentTime = document.getElementById('currentTime');
const nextDeparture = document.getElementById('nextDeparture');
const countdown = document.getElementById('countdown');

const stationControls = document.getElementById('stationControls');
const departBtn = document.getElementById('departBtn');
const nextBtn = document.getElementById('nextBtn');
const endBtn = document.getElementById('endBtn');
const timerDisplay = document.getElementById('timerDisplay');
const statusDiv = document.getElementById('status');

const timetableCard = document.getElementById('timetableCard');
const tableTitle = document.getElementById('tableTitle');
const tableBody = document.getElementById('tableBody');

const activeDriversDiv = document.getElementById('activeDrivers');
const driversList = document.getElementById('driversList');
const userBadge = document.getElementById('userBadge');

const adminPanel = document.getElementById('adminPanel');
const routesList = document.getElementById('routesList');
const logsList = document.getElementById('logsList');
const addRouteBtn = document.getElementById('addRouteBtn');
const newRouteName = document.getElementById('newRouteName');
const newRouteFreq = document.getElementById('newRouteFreq');
const newRouteStops = document.getElementById('newRouteStops');
const refreshRoutesBtn = document.getElementById('refreshRoutesBtn');
const clearLogsBtn = document.getElementById('clearLogsBtn');
const exportLogsBtn = document.getElementById('exportLogsBtn');

/* -------------------------
   App state
------------------------- */
let CURRENT_USER = null;
let CURRENT_USER_IS_ADMIN = false;
let selectedRouteName = null;
let selectedRoute = null;
let useReverse = false;
let expectedArrival = null;
let timerInterval = null;
let currentStopIndex = 0;
let actualDepartTime = null;
let activeDrivers = [];

/* -------------------------
   Login / Logout
------------------------- */
loginBtn.addEventListener('click', ()=>{
  const u=usernameEl.value.trim(); const p=passwordEl.value;
  loginMsg.textContent='';
  if(!u||!p){ loginMsg.textContent='Enter username & password'; return; }
  const userRecord=USERS[u];
  if(!userRecord||userRecord.pw!==p){ loginMsg.textContent='Invalid username or password'; return; }
  CURRENT_USER=u; CURRENT_USER_IS_ADMIN=!!userRecord.admin;
  document.getElementById('loginSection').style.display='none';
  driverControls.style.display='block';
  logoutBtn.style.display='inline-block';
  userBadge.style.display='inline-block';
  userBadge.textContent=`${CURRENT_USER}${CURRENT_USER_IS_ADMIN?' (admin)':''}`;
  addActiveDriver(CURRENT_USER);
  populateRoutesSelect();
  if(CURRENT_USER_IS_ADMIN){ adminPanel.style.display='block'; populateAdminRoutes(); populateLogs(); }
});

logoutBtn.addEventListener('click', ()=>{
  CURRENT_USER=null; CURRENT_USER_IS_ADMIN=false;
  document.getElementById('loginSection').style.display='block';
  driverControls.style.display='none';
  adminPanel.style.display='none';
  timetableCard.style.display='none';
  stationControls.style.display='none';
  activeDriversDiv.style.display='none';
  logoutBtn.style.display='none';
  userBadge.style.display='none';
});

/* -------------------------
   Active drivers
------------------------- */
function addActiveDriver(name){
  if(!name) return;
  if(!activeDrivers.includes(name)) activeDrivers.push(name);
  renderActiveDrivers();
}
function renderActiveDrivers(){
  driversList.innerHTML='';
  activeDrivers.forEach(d=>{
    const li=document.createElement('li'); li.textContent=d; driversList.appendChild(li);
  });
  activeDriversDiv.style.display=activeDrivers.length?'block':'none';
}

/* -------------------------
   Routes select & timetable
------------------------- */
function populateRoutesSelect(){
  lineSelect.innerHTML='';
  Object.keys(ROUTES).sort().forEach(n=>{
    const opt=document.createElement('option'); opt.value=n; opt.textContent=n;
    lineSelect.appendChild(opt);
  });
  if(lineSelect.options.length) lineSelect.value=lineSelect.options[0].value;
}

confirmBtn.addEventListener('click', ()=>{
  selectedRouteName=lineSelect.value; useReverse=false;
  loadSelectedRoute();
});
reverseBtn.addEventListener('click', ()=>{
  if(!selectedRouteName) return;
  useReverse=!useReverse; loadSelectedRoute();
});

function loadSelectedRoute(){
  if(!selectedRouteName) return;
  selectedRoute=ROUTES[selectedRouteName];
  let displayName=selectedRouteName;
  if(useReverse){
    const revName=selectedRouteName.endsWith(' 2')? selectedRouteName.replace(/ 2$/,'') : (selectedRouteName+' 2');
    if(ROUTES[revName]){ selectedRoute=ROUTES[revName]; displayName=revName; }
  }
  tableTitle.textContent=displayName;
  renderTimetable(selectedRoute);
  timetableCard.style.display='block';
  stationControls.style.display='block';
  clearTimer(); timerDisplay.textContent='--:--'; timerDisplay.style.background='var(--good)'; statusDiv.textContent='';
}

/* -------------------------
   Timetable render
------------------------- */
function renderTimetable(route, departTime=null){
  tableBody.innerHTML='';
  if(!route) return;
  route.stops.forEach((stop,i)=>{
    const tr=document.createElement('tr');
    const tdStop=document.createElement('td'); tdStop.textContent=stop.name||stop;
    const tdTime=document.createElement('td');
    let arrival = departTime? new Date(departTime.getTime()+i*60000) : getNextDeparture(new Date(), route.freq);
    if(!departTime) arrival=new Date(arrival.getTime()+i*60000);
    tdTime.textContent=departTime? formatTime(arrival): formatTime(arrival);
    if(departTime && i<=currentStopIndex){
      const diffSec=Math.floor((arrival - (departTime.getTime()+i*60000))/1000);
      if(diffSec!==0){
        const span=document.createElement('span');
        span.textContent=` (${diffSec>0?'+':''}${diffSec}s)`; span.style.color=diffSec>0?'red':'green'; span.style.fontSize='0.8em';
        tdTime.appendChild(span);
      }
    }
    tr.appendChild(tdStop); tr.appendChild(tdTime); tableBody.appendChild(tr);
  });
}

/* -------------------------
   Next Departure calculation
------------------------- */
function getNextDeparture(now,freq){ const mins=now.getMinutes(); const rem=mins%freq; const next=new Date(now); next.setMinutes(mins+(rem===0?freq:freq-rem)); next.setSeconds(0,0); return next; }

/* -------------------------
   Clock update
------------------------- */
setInterval(()=>{
  const n=new Date();
  currentTime.textContent=n.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});
  if(selectedRoute){
    const next=getNextDeparture(n, selectedRoute.freq);
    nextDeparture.textContent=formatTime(next);
    const diff=Math.ceil((next-n)/1000);
    countdown.textContent=diff>0? `${Math.floor(diff/60)}m ${diff%60}s` : '0m 0s';
  }
},1000);

/* -------------------------
   Depart / Next / End logic
------------------------- */
departBtn.addEventListener('click', ()=>{
  if(!selectedRoute){ alert('Load a route first'); return; }
  currentStopIndex=0;
  actualDepartTime=new Date();
  expectedArrival=new Date(actualDepartTime.getTime()+60000);
  renderTimetable(selectedRoute, actualDepartTime);
  updateTimerDisplay();
  timerInterval=setInterval(updateTimerDisplay,1000);
  stationControls.style.display='block';
  statusDiv.textContent=`Departed: ${selectedRoute.stops[currentStopIndex].name || selectedRoute.stops[currentStopIndex]}`;
});

nextBtn.addEventListener('click', ()=>{
  if(!selectedRoute||!expectedArrival) return;
  const now=new Date();
  const secRemaining=Math.ceil((expectedArrival-now)/1000);
  if(secRemaining>15){ statusDiv.textContent=`You can click Next only in last 15s or when late (${secRemaining}s left)`; return; }

  const diff=Math.floor((now-expectedArrival)/1000);
  statusDiv.innerHTML=diff<=0? `<span class="ok">On Time ✅</span> &nbsp;(${formatDiffSec(Math.abs(diff))})`
                             : `<span class="danger">Late ❌</span> &nbsp;(${formatDiffSec(diff)})`;

  currentStopIndex++;
  if(currentStopIndex>=selectedRoute.stops.length){ endRoute(); return; }

  expectedArrival=new Date(now.getTime()+60000);
  renderTimetable(selectedRoute, actualDepartTime);
});

endBtn.addEventListener('click', ()=>{ endRoute(); });

function endRoute(){
  clearTimer(); timerDisplay.textContent='--:--'; timerDisplay.style.background='var(--good)';
  statusDiv.textContent='Route completed!'; currentStopIndex=0;
  renderTimetable(selectedRoute, actualDepartTime);
}

function updateTimerDisplay(){
  if(!expectedArrival){ timerDisplay.textContent='--:--'; return; }
  const diffSec=Math.ceil((expectedArrival-new Date())/1000);
  if(diffSec>0){ timerDisplay.style.background='var(--good)'; timerDisplay.textContent=formatDiffSec(diffSec); nextBtn.disabled=diffSec>15; }
  else { timerDisplay.style.background='var(--bad)'; timerDisplay.textContent='-'+formatDiffSec(Math.abs(diffSec)); nextBtn.disabled=false; }
}

function clearTimer(){ if(timerInterval) clearInterval(timerInterval); timerInterval=null; expectedArrival=null; nextBtn.disabled=true; }

/* -------------------------
   Logs
------------------------- */
function logShift(user,routeName){
  const entry={user,route:routeName,time:new Date().toISOString()};
  LOGS.unshift(entry); saveLogs(LOGS);
  if(CURRENT_USER_IS_ADMIN) populateLogs();
}

function populateLogs(){
  logsList.innerHTML='';
  if(!LOGS.length){ logsList.textContent='No shift logs yet'; return; }
  LOGS.forEach((l,idx)=>{
    const wrap=document.createElement('div'); wrap.className='logItem';
    const left=document.createElement('div'); left.innerHTML=`<strong>${l.user}</strong> - ${l.route} <div class="mutedSmall">${(new Date(l.time)).toLocaleString()}</div>`;
    const right=document.createElement('div');
    const del=document.createElement('button'); del.className='smallBtn'; del.textContent='Delete'; del.addEventListener('click',()=>{
      if(!confirm('Delete this log?')) return; LOGS.splice(idx,1); saveLogs(LOGS); populateLogs();
    });
    right.appendChild(del); wrap.appendChild(left); wrap.appendChild(right); logsList.appendChild(wrap);
  });
}

/* -------------------------
   Admin routes management
------------------------- */
function populateAdminRoutes(){
  routesList.innerHTML='';
  Object.keys(ROUTES).sort().forEach(n=>{
    const div=document.createElement('div'); div.style.display='flex'; div.style.justifyContent='space-between'; div.style.alignItems='center'; div.style.marginBottom='8px';
    const left=document.createElement('div'); left.innerHTML=`<strong>${n}</strong> <div class="mutedSmall">${ROUTES[n].freq} min — ${ROUTES[n].stops.length} stops</div>`;
    const right=document.createElement('div');
    const delBtn=document.createElement('button'); delBtn.className='smallBtn'; delBtn.textContent='Delete'; delBtn.addEventListener('click',()=>{
      if(!confirm(`Delete route "${n}" and its reverse?`)) return; deleteRouteAndReverse(n); populateAdminRoutes(); populateRoutesSelect();
    });
    right.appendChild(delBtn); div.appendChild(left); div.appendChild(right); routesList.appendChild(div);
  });
}

function deleteRouteAndReverse(name){
  const rev=name.endsWith(' 2')? name.replace(/ 2$/,''): name+' 2';
  if(ROUTES[name]) delete ROUTES[name]; if(ROUTES[rev]) delete ROUTES[rev]; saveRoutes(ROUTES);
}

addRouteBtn.addEventListener('click',()=>{
  const name=newRouteName.value.trim(); const freq=parseInt(newRouteFreq.value,10)||10; const stopsRaw=newRouteStops.value.trim();
  if(!name||!stopsRaw){ alert('Provide route name and stops.'); return; }
  const arr=stopsRaw.split(/\r?\n|,/).map(s=>s.trim()).filter(Boolean);
  const stopsObj=arr.map((s,i)=>({name:s,offset:i}));
  ROUTES[name]={freq,stops:stopsObj};
  const revName=name+' 2'; if(!ROUTES[revName]){ const revStops=[...stopsObj].slice().reverse().map((s,i)=>({name:s.name,offset:i})); ROUTES[revName]={freq,stops:revStops}; }
  saveRoutes(ROUTES); populateAdminRoutes(); populateRoutesSelect();
  newRouteName.value=''; newRouteFreq.value=''; newRouteStops.value='';
});

refreshRoutesBtn.addEventListener('click',()=>{ ROUTES=loadRoutes(); populateAdminRoutes(); populateRoutesSelect(); });
clearLogsBtn.addEventListener('click',()=>{ if(confirm('Clear all logs?')){ LOGS=[]; saveLogs(LOGS); populateLogs(); } });
exportLogsBtn.addEventListener('click',()=>{
  const blob=new Blob([JSON.stringify(LOGS,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='erlc_logs.json'; a.click();
  URL.revokeObjectURL(url);
});

/* -------------------------
   Helpers
------------------------- */
function formatTime(d){ return d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}); }
function formatDiffSec(s){ s=Math.floor(Math.abs(s)); return `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; }
</script>
