<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ERLC Bus Scheduler</title>
<style>
:root{
  --bg:#0f1724; --card:#0b1220; --accent:#ff6b6b; --muted:#9aa4c0; --good:#1cc88a; --bad:#e43f5a; --panel:#0f3460;
}
*{box-sizing:border-box}
body{margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
  background:linear-gradient(180deg,#071024 0%, #0e1530 100%); color:#edf2f7;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
header{padding:18px 24px;border-bottom:1px solid rgba(255,255,255,.03);display:flex;align-items:center;gap:12px}
h1{margin:0;font-size:18px}
.wrap{display:flex;gap:20px;padding:20px;max-width:1200px;margin:20px auto}
.card{background:var(--card);border-radius:12px;padding:18px;width:360px;box-shadow:0 6px 30px rgba(2,6,23,.6)}
.wide{flex:1;min-width:360px;padding:18px}
label{display:block;font-size:13px;color:var(--muted);margin-top:8px}
input,select,textarea,button{width:100%;padding:10px;border-radius:8px;border:0;font-size:14px}
textarea{min-height:88px;resize:vertical}
button{background:var(--accent);color:#fff;border:0;cursor:pointer}
.muted{color:var(--muted);font-size:13px}
.infoRow{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:10px}
.big{font-weight:700;font-size:18px}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,.03);font-size:14px}
th{color:#fff;background:linear-gradient(90deg,var(--accent),#ff907a);border-radius:6px}
.smallBtn{padding:6px 8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,.06);color:var(--muted);cursor:pointer}
#activeDrivers{position:fixed;left:18px;bottom:18px;background:var(--panel);padding:12px;border-radius:10px;min-width:200px;box-shadow:0 8px 30px rgba(0,0,0,.6)}
#activeDrivers h3{margin:0 0 6px 0;color:var(--good);font-size:14px}
.timer{margin-top:12px;padding:10px;border-radius:8px;text-align:center;font-weight:700;font-size:20px;color:#fff;background:var(--good);min-width:120px}
.status{margin-top:8px;font-weight:600}
.adminPanel{background:#07183a;padding:12px;border-radius:10px}
.row{display:flex;gap:8px}
.row > *{flex:1}
.mutedSmall{font-size:12px;color:var(--muted)}
.logItem{display:flex;justify-content:space-between;gap:10px;align-items:center;padding:8px;border-radius:6px;background:rgba(255,255,255,.02);margin-bottom:8px}
.danger{background:rgba(228,63,90,.08);border:1px solid rgba(228,63,90,.12);color:var(--bad);padding:6px 8px;border-radius:8px}
.ok{background:rgba(28,200,138,.06);border:1px solid rgba(28,200,138,.12);color:var(--good);padding:6px 8px;border-radius:8px}
.inlineSmall{display:inline-block;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,.02);color:var(--muted);font-size:13px}
.editField{width:100%;padding:6px;margin-top:6px;border-radius:6px;border:1px solid rgba(255,255,255,.04);background:transparent;color:inherit}
</style>
</head>
<body>

<header>
  <h1>ERLC Bus Scheduler</h1>
  <div style="margin-left:auto" class="mutedSmall">Local demo — data saved in browser storage</div>
</header>

<div class="wrap">
  <!-- left column: login + driver controls -->
  <div class="card">
    <div id="loginSection">
      <h2 style="margin:0 0 8px 0">Login</h2>
      <label>Username</label>
      <input id="username" placeholder="username" />
      <label>Password</label>
      <input id="password" type="password" placeholder="password" />
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="loginBtn">Login</button>
        <button id="logoutBtn" style="display:none;background:#6c757d">Logout</button>
      </div>
      <div id="loginMsg" class="mutedSmall" style="margin-top:8px;color:#ffb4b4"></div>
      <button id="openDeparturesBtn" style="margin-top:8px;background:#1cc88a;">Vertrektijden</button>
    </div>

    <div id="driverControls" style="display:none;margin-top:12px">
      <h3 style="margin:0 0 8px 0">Driver Controls</h3>
      <label>Choose Line</label>
      <select id="lineSelect"></select>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="confirmBtn">Load Timetable</button>
        <button id="reverseBtn" title="Toggle original/return" class="smallBtn">Reverse</button>
      </div>

      <div class="infoRow">
        <div>
          <div class="mutedSmall">Current time</div>
          <div id="currentTime" class="big"></div>
        </div>
        <div style="text-align:right">
          <div class="mutedSmall">Next departure</div>
          <div id="nextDeparture" class="big">--:--</div>
        </div>
      </div>

      <div style="margin-top:10px">
        <div class="mutedSmall">Countdown to next departure</div>
        <div id="countdown" class="timer">--:--</div>
      </div>

      <div id="stationControls" style="display:none;margin-top:12px">
        <div style="display:flex;gap:8px">
          <button id="departBtn">Depart</button>
          <button id="nextBtn" disabled>Next Station</button>
          <button id="endBtn">End</button>
        </div>
        <div id="currentStation" class="status" style="margin-top:6px"></div>
        <div id="timerDisplay" class="timer" style="margin-top:10px;background:var(--good)">--:--</div>
        <div id="status" class="status mutedSmall"></div>
        <div style="margin-top:8px" class="mutedSmall">*Next Station button only in last 15s before arrival or when late.</div>
      </div>
    </div>
  </div>

  <!-- middle: timetable / logs -->
  <div class="wide card" style="min-width:520px">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2 style="margin:0">Timetable & Admin</h2>
      <div id="userBadge" class="inlineSmall" style="display:none"></div>
    </div>

    <div id="timetableCard" style="margin-top:12px; display:none">
      <div class="mutedSmall">Timetable for <strong id="tableTitle"></strong></div>
      <table id="timetableTable">
        <thead><tr><th>Stop</th><th>Arrival</th></tr></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <!-- admin panel (visible to admins only) -->
    <div id="adminPanel" style="margin-top:16px;display:none" class="adminPanel">
      <h3 style="margin:0 0 8px 0;color:var(--good)">Admin Panel</h3>

      <div style="display:flex;gap:10px">
        <div style="flex:1">
          <label>New Route name</label>
          <input id="newRouteName" placeholder="e.g. Line X" />
          <label>Frequency (minutes)</label>
          <input id="newRouteFreq" placeholder="10" />
          <label>Stops (one per line or comma separated)</label>
          <textarea id="newRouteStops" placeholder="Spawn&#10;Chinatown&#10;Fire Department"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="addRouteBtn">Add Route</button>
            <button id="refreshRoutesBtn" class="smallBtn">Refresh</button>
          </div>

          <hr style="border:none;border-top:1px solid rgba(255,255,255,.03);margin:12px 0">

          <label>Create User</label>
          <input id="newUsername" placeholder="username">
          <input id="newPassword" type="password" placeholder="password">
          <button id="createUserBtn" style="margin-top:6px">Create User</button>

          <label style="margin-top:10px">Give Strikes</label>
          <select id="strikeSelect"></select>
          <input id="strikeAmount" placeholder="Number of strikes" type="number">
          <div style="display:flex;gap:8px;margin-top:6px">
            <button id="giveStrikeBtn">Give Strike</button>
            <button id="removeStrikeBtn" class="smallBtn">Remove Strike</button>
          </div>
        </div>

        <div style="width:260px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="mutedSmall">Routes</div>
            <div class="mutedSmall">Actions</div>
          </div>
          <div id="routesList" style="margin-top:8px;max-height:280px;overflow:auto"></div>

          <div style="margin-top:12px" class="mutedSmall">Shift Logs</div>
          <div id="logsList" style="margin-top:8px;max-height:220px;overflow:auto"></div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- active drivers -->
<div id="activeDrivers" style="display:none">
  <h3>Active Drivers</h3>
  <ul id="driversList" style="margin:0;padding-left:18px"></ul>
</div>

<script>
/* ============================================================
   CONFIG
   ============================================================ */
const DISCORD_BOT_ENDPOINT = "https://erlc-bot-meqt.onrender.com"; // your bot server
window.DISCORD_BOT_ENDPOINT = DISCORD_BOT_ENDPOINT;

/* ============================================================
   STORAGE KEYS
   ============================================================ */
const STORAGE_USERS = 'erlc_users_v3';
const STORAGE_ROUTES = 'erlc_routes_v3';
const STORAGE_LOGS = 'erlc_logs_v3';
const STORAGE_ACTIVE = 'erlc_activeDrivers_v3';
const STORAGE_STRIKES = 'erlc_strikes_v3';

/* ============================================================
   DEFAULT DATA
   ============================================================ */
const defaultUsers = {
  "pwatg123admin": {pw:"utrechtov20092025", admin:true},
  "thijs_1920": {pw:"1920", admin:true},
  "Roidkyadmin": {pw:"Mohamed4obai", admin:true},
  "finn05545": {pw:"12345678910", admin:false},
  "itsjeboyjasper": {pw:"DURPJasper1101", admin:false},
  "pwatg123": {pw:"utrechtov20092025", admin:false},
  "Ilias123": {pw:"Pass123", admin:false},
  "milandepro7": {pw:"Utrechtov20702025", admin:false},
  "blobvisje.": {pw:"pass123", admin:false}
};

const defaultRoutes = {
  "Line 6": {
    freq: 10,
    stops: [
      { name: "Spawn",            postal: "202",  img: "Spawn.jpg" },
      { name: "Fire Department",  postal: "210",  img: "Fire Department.jpg" },
      { name: "Central Park",     postal: "216",  img: "Central Park.jpg" },
      { name: "P+R Transferium",  postal: "410",  img: "P+R Transferium.jpg" },
      { name: "Farms",            postal: "601",  img: "Farms.jpg" },
      { name: "Highrock",         postal: "1201", img: "Highrock.jpg" }
    ]
  },
  "Line 9 Shuttlebus": {
    freq: 10,
    stops: [
      { name: "Spawn",            postal: "202", img: "Spawn.jpg" },
      { name: "Fire Department",  postal: "210", img: "Fire Department.jpg" },
      { name: "Central Park",     postal: "216", img: "Central Park.jpg" }
    ]
  },
  "Line 15 Shuttlebus": {
    freq: 10,
    stops: [
      { name: "Spawn",            postal: "202",  img: "Spawn.jpg" },
      { name: "Repair shop",      postal: "2011", img: "Repair shop.jpg" },
      { name: "P+R Transferium",  postal: "410",  img: "P+R Transferium.jpg" }
    ]
  },
  "Lijn 12": {
    freq: 10,
    stops: [
      { name: "Spawn",            postal: "202",  img: "Spawn.jpg" },
      { name: "Chinatown",        postal: "2002", img: "Chinatown.jpg" },
      { name: "Fire Department",  postal: "210",  img: "Fire Department.jpg" },
      { name: "Central Park",     postal: "216",  img: "Central Park.jpg" },
      { name: "Hospital",         postal: "404",  img: "Hospital.jpg" },
      { name: "Farms",            postal: "601",  img: "Farms.jpg" },
      { name: "Highrock",         postal: "1201", img: "Highrock.jpg" },
      { name: "Springfield",      postal: "1107", img: "Springfield.jpg" }
    ]
  },
  "FastLine": {
    freq: 8,
    stops: [
      { name: "Springfield", postal: "1107", img: "Springfield.jpg" },
      { name: "River City",  postal: "999",  img: "River City.jpg" } // temp code
    ]
  }
};

/* ============================================================
   STORAGE HELPERS
   ============================================================ */
function save(key, value){ localStorage.setItem(key, JSON.stringify(value)); }
function load(key, fallback){ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }

function saveUsers(u){ save(STORAGE_USERS, u); }
function loadUsers(){ return load(STORAGE_USERS, defaultUsers); }

function saveRoutes(r){ save(STORAGE_ROUTES, r); }
function loadRoutes(){
  let r = load(STORAGE_ROUTES, null);
  if(!r){
    r = JSON.parse(JSON.stringify(defaultRoutes));
    // auto-build reverse routes with plain names (reverse objects)
    Object.keys(defaultRoutes).forEach(name=>{
      const rev = name + " 2";
      if(!r[rev]) r[rev] = {freq: defaultRoutes[name].freq, stops: [...defaultRoutes[name].stops].slice().reverse()};
    });
    saveRoutes(r);
  }
  return r;
}

function saveLogs(l){ save(STORAGE_LOGS, l); }
function loadLogs(){ return load(STORAGE_LOGS, []); }

function saveActive(a){ save(STORAGE_ACTIVE, a); }
function loadActive(){ return load(STORAGE_ACTIVE, []); }

function saveStrikes(s){ save(STORAGE_STRIKES, s); }
function loadStrikes(){ return load(STORAGE_STRIKES, {}); }

/* ============================================================
   IN-MEMORY APP STATE
   ============================================================ */
let USERS = loadUsers();
let ROUTES = loadRoutes();
let LOGS = loadLogs();
let ACTIVE_DRIVERS = loadActive();
let STRIKES = loadStrikes();

let CURRENT_USER = null;
let CURRENT_USER_IS_ADMIN = false;

let selectedRouteName = null;
let selectedRoute = null;

let actualDepartureTime = null;
let currentStopIndex = 0;
let timerInterval = null;

/* ============================================================
   UTILITIES
   ============================================================ */
function now(){ return new Date(); }
function pad(n){ return String(n).padStart(2,'0'); }
function formatTime(d){ return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }
function formatTimeWithSeconds(d){ return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'}); }
function formatDiffSec(s){
  s = Math.floor(Math.abs(s));
  const mm = Math.floor(s/60);
  const ss = s%60;
  return `${pad(mm)}:${pad(ss)}`;
}
function getStopName(stop){ return typeof stop === 'object' ? stop.name : stop; }
function getStopPostal(stop){ return typeof stop === 'object' ? (stop.postal || '') : ''; }

function getNextDeparture(dateObj, freq){
  const next = new Date(dateObj);
  const mins = next.getMinutes();
  const rem = mins % freq;
  const add = rem === 0 ? 0 : (freq - rem);
  next.setMinutes(mins + add);
  next.setSeconds(0,0);
  if(next < dateObj) next.setMinutes(next.getMinutes()+freq);
  return next;
}

/* ============================================================
   DOM
   ============================================================ */
const usernameEl = document.getElementById('username');
const passwordEl = document.getElementById('password');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const loginMsg = document.getElementById('loginMsg');

const driverControls = document.getElementById('driverControls');
const lineSelect = document.getElementById('lineSelect');
const confirmBtn = document.getElementById('confirmBtn');
const reverseBtn = document.getElementById('reverseBtn');

const currentTimeEl = document.getElementById('currentTime');
const nextDepartureEl = document.getElementById('nextDeparture');
const countdownEl = document.getElementById('countdown');

const stationControls = document.getElementById('stationControls');
const departBtn = document.getElementById('departBtn');
const nextBtn = document.getElementById('nextBtn');
const endBtn = document.getElementById('endBtn');
const currentStationEl = document.getElementById('currentStation');
const timerDisplay = document.getElementById('timerDisplay');
const statusDiv = document.getElementById('status');

const timetableCard = document.getElementById('timetableCard');
const tableTitle = document.getElementById('tableTitle');
const tableBody = document.getElementById('tableBody');

const activeDriversDiv = document.getElementById('activeDrivers');
const driversList = document.getElementById('driversList');
const userBadge = document.getElementById('userBadge');

const adminPanel = document.getElementById('adminPanel');
const routesList = document.getElementById('routesList');
const logsList = document.getElementById('logsList');

const newUsername = document.getElementById('newUsername');
const newPassword = document.getElementById('newPassword');
const createUserBtn = document.getElementById('createUserBtn');
const strikeSelect = document.getElementById('strikeSelect');
const strikeAmount = document.getElementById('strikeAmount');
const giveStrikeBtn = document.getElementById('giveStrikeBtn');
const removeStrikeBtn = document.getElementById('removeStrikeBtn');

const newRouteName = document.getElementById('newRouteName');
const newRouteFreq = document.getElementById('newRouteFreq');
const newRouteStops = document.getElementById('newRouteStops');
const addRouteBtn = document.getElementById('addRouteBtn');
const refreshRoutesBtn = document.getElementById('refreshRoutesBtn');

/* ============================================================
   RENDERING
   ============================================================ */
function renderActiveDrivers(){
  driversList.innerHTML = '';
  ACTIVE_DRIVERS.forEach(name=>{
    const li = document.createElement('li');
    li.textContent = name;
    driversList.appendChild(li);
  });
  activeDriversDiv.style.display = ACTIVE_DRIVERS.length ? 'block' : 'none';
}
function populateRoutesSelect(){
  lineSelect.innerHTML = '';
  Object.keys(ROUTES).sort().forEach(n=>{
    const o = document.createElement('option');
    o.value = n; o.textContent = n;
    lineSelect.appendChild(o);
  });
  if(lineSelect.options.length) lineSelect.value = lineSelect.options[0].value;
}
function renderRouteRow(name){
  const row = document.createElement('div');
  row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center';
  row.style.marginBottom='8px';

  const left = document.createElement('div');
  left.innerHTML = `<strong>${name}</strong> <div class="mutedSmall">${ROUTES[name].freq} min — ${ROUTES[name].stops.length} stops</div>`;

  const right = document.createElement('div'); right.style.display='flex'; right.style.gap='6px';

  const editBtn = document.createElement('button');
  editBtn.className='smallBtn'; editBtn.textContent='Edit';
  editBtn.addEventListener('click', ()=>openEditRouteDialog(name));

  const delBtn = document.createElement('button');
  delBtn.className='smallBtn'; delBtn.textContent='Delete';
  delBtn.addEventListener('click', ()=>{
    if(!confirm(`Delete route "${name}" and its reverse?`)) return;
    delete ROUTES[name];
    const rev = name.endsWith(' 2') ? name.replace(/ 2$/,'') : (name + ' 2');
    if(ROUTES[rev]) delete ROUTES[rev];
    saveRoutes(ROUTES); populateRoutesSelect(); populateAdminLists();
  });

  right.appendChild(editBtn); right.appendChild(delBtn);
  row.appendChild(left); row.appendChild(right);
  return row;
}
function populateAdminLists(){
  routesList.innerHTML = '';
  Object.keys(ROUTES).sort().forEach(name=>{
    routesList.appendChild(renderRouteRow(name));
  });

  strikeSelect.innerHTML = '';
  Object.keys(USERS).sort().forEach(u=>{
    const o = document.createElement('option');
    o.value = u; o.textContent = u;
    strikeSelect.appendChild(o);
  });

  renderLogs();
}
function renderLogs(){
  logsList.innerHTML = '';
  if(!LOGS.length){
    logsList.textContent = 'No shift logs';
    return;
  }
  LOGS.forEach((l, idx)=>{
    const wrap = document.createElement('div'); wrap.className='logItem';
    const left = document.createElement('div');
    left.innerHTML = `<strong>${l.user}</strong> - ${l.route} <div class="mutedSmall">${new Date(l.time).toLocaleString()}</div>`;
    const right = document.createElement('div');
    const del = document.createElement('button'); del.className='smallBtn'; del.textContent='Delete';
    del.addEventListener('click', ()=>{
      if(!confirm('Delete this log?')) return;
      LOGS.splice(idx,1); saveLogs(LOGS); renderLogs();
    });
    right.appendChild(del);
    wrap.appendChild(left); wrap.appendChild(right);
    logsList.appendChild(wrap);
  });
}

function renderDynamicTimetable(route, departTime){
  tableBody.innerHTML = '';
  if(!route) return;

  const baseDepart = departTime ? new Date(departTime) : getNextDeparture(new Date(), route.freq);
  nextDepartureEl.textContent = formatTime(baseDepart);

  route.stops.forEach((stop, i)=>{
    const tr = document.createElement('tr');

    // STOP CELL
    const tdStop = document.createElement('td');
    const stopName = getStopName(stop);
    tdStop.textContent = stopName || 'Unknown';
    const postal = getStopPostal(stop);
    if(postal){
      const info = document.createElement('div');
      info.className = 'mutedSmall';
      info.textContent = `Postcode: ${postal}`;
      tdStop.appendChild(info);
    }

    // TIME CELL
    const tdTime = document.createElement('td');
    const arrival = new Date(baseDepart.getTime() + i*60000);
    tdTime.textContent = formatTime(arrival);

    // delta badge only when departTime present
    if(departTime){
      const scheduledBase = getNextDeparture(new Date(), route.freq);
      const scheduledArrival = new Date(scheduledBase.getTime() + i*60000);
      const deltaSec = Math.round((arrival - scheduledArrival)/1000);
      if(deltaSec !== 0){
        const deltaMin = Math.floor(Math.abs(deltaSec)/60);
        const deltaRem = Math.abs(deltaSec)%60;
        const sign = deltaSec > 0 ? '+' : '-';
        const span = document.createElement('span');
        span.className = 'delta-badge';
        span.style.marginLeft = '8px';
        span.style.fontSize = '12px';
        span.style.padding = '2px 6px';
        span.style.borderRadius = '6px';
        span.textContent = `${sign}${deltaMin}:${pad(deltaRem)}`;
        span.style.background = deltaSec > 0 ? 'rgba(228,63,90,0.12)' : 'rgba(28,200,138,0.06)';
        tdTime.appendChild(span);
      }
    }

    tr.appendChild(tdStop); tr.appendChild(tdTime);
    tableBody.appendChild(tr);
  });
}

/* ============================================================
   CLOCK / COUNTDOWN
   ============================================================ */
setInterval(()=>{
  const n = new Date();
  currentTimeEl.textContent = formatTimeWithSeconds(n);

  if(selectedRoute && !actualDepartureTime){
    const next = getNextDeparture(new Date(), selectedRoute.freq);
    const diff = Math.ceil((next - new Date())/1000);
    countdownEl.textContent = diff > 0 ? `${pad(Math.floor(diff/60))}:${pad(diff%60)}` : '00:00';
  }
}, 1000);

/* ============================================================
   LOGIN / LOGOUT
   ============================================================ */
loginBtn.addEventListener('click', ()=>{
  const u = usernameEl.value.trim();
  const p = passwordEl.value;
  loginMsg.textContent = '';
  if(!u || !p){ loginMsg.textContent = 'Enter username & password'; return; }

  const rec = USERS[u];
  if(!rec || rec.pw !== p){ loginMsg.textContent = 'Invalid username or password'; return; }

  CURRENT_USER = u;
  CURRENT_USER_IS_ADMIN = !!rec.admin;

  document.getElementById('loginSection').style.display = 'none';
  driverControls.style.display = 'block';
  logoutBtn.style.display = 'inline-block';
  userBadge.style.display = 'inline-block';
  userBadge.textContent = `${CURRENT_USER}${CURRENT_USER_IS_ADMIN ? ' (admin)' : ''}`;

  if(!ACTIVE_DRIVERS.includes(CURRENT_USER)){
    ACTIVE_DRIVERS.push(CURRENT_USER); saveActive(ACTIVE_DRIVERS); renderActiveDrivers();
  }

  populateRoutesSelect();
  populateAdminLists();
  timetableCard.style.display = 'none';
  stationControls.style.display = 'none';
  adminPanel.style.display = CURRENT_USER_IS_ADMIN ? 'block' : 'none';
});

logoutBtn.addEventListener('click', ()=>{
  if(CURRENT_USER){
    const idx = ACTIVE_DRIVERS.indexOf(CURRENT_USER);
    if(idx !== -1){ ACTIVE_DRIVERS.splice(idx,1); saveActive(ACTIVE_DRIVERS); renderActiveDrivers(); }
  }
  CURRENT_USER = null; CURRENT_USER_IS_ADMIN = false;
  document.getElementById('loginSection').style.display = 'block';
  driverControls.style.display = 'none';
  adminPanel.style.display = 'none';
  timetableCard.style.display = 'none';
  stationControls.style.display = 'none';
  logoutBtn.style.display = 'none';
  userBadge.style.display = 'none';
});

/* ============================================================
   ROUTE LOAD (route-lock removed)
   ============================================================ */
function canLoadRoute(){ return true; } // always allow

confirmBtn.addEventListener('click', ()=>{
  if(!CURRENT_USER){ loginMsg.textContent = 'Please login first'; return; }
  selectedRouteName = lineSelect.value;
  if(!canLoadRoute(selectedRouteName)) return; // always true

  selectedRoute = ROUTES[selectedRouteName];
  tableTitle.textContent = selectedRouteName;

  const next = getNextDeparture(new Date(), selectedRoute.freq);
  nextDepartureEl.textContent = formatTime(next);
  renderDynamicTimetable(selectedRoute, next);

  timetableCard.style.display = 'block';
  stationControls.style.display = 'block';

  actualDepartureTime = null;
  currentStopIndex = 0;
  timerDisplay.textContent = '--:--';
  currentStationEl.textContent = '';
  statusDiv.textContent = '';
});

reverseBtn.addEventListener('click', ()=>{
  if(!lineSelect.value) return;
  const name = lineSelect.value;
  const revName = name.endsWith(' 2')? name.replace(/ 2$/,'') : name + ' 2';
  if(ROUTES[revName]) lineSelect.value = revName;
});

/* ============================================================
   DEPART / NEXT / END
   ============================================================ */
departBtn.addEventListener('click', ()=>{
  if(!selectedRoute){ alert('Load a route first'); return; }

  actualDepartureTime = new Date();
  currentStopIndex = 0;

  LOGS.unshift({ user: CURRENT_USER, route: selectedRouteName, time: new Date().toISOString(), departTime: actualDepartureTime.toISOString() });
  saveLogs(LOGS); renderLogs();

  renderDynamicTimetable(selectedRoute, actualDepartureTime);
  startStopTimerForIndex(currentStopIndex);
  statusDiv.textContent = `Departed: ${getStopName(selectedRoute.stops[currentStopIndex])}`;

  // Notify Discord and register departure board
  try{
    fetch(`${DISCORD_BOT_ENDPOINT}/next-station`,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        routeName: selectedRouteName,
        stationName: getStopName(selectedRoute.stops[currentStopIndex])
      })
    });
  }catch(e){ console.warn('Bot request failed:', e); }

  registerDeparture(selectedRouteName, getStopName(selectedRoute.stops[0]), actualDepartureTime);
});

nextBtn.addEventListener('click', ()=>{
  if(!selectedRoute || !actualDepartureTime) return;

  const arrivalForCurrent = new Date(actualDepartureTime.getTime() + currentStopIndex*60000);
  const secRemaining = Math.ceil((arrivalForCurrent - new Date())/1000);
  if(secRemaining > 15){
    statusDiv.textContent = `Next Station only in last 15s before arrival (${secRemaining}s left)`;
    return;
  }

  const diff = Math.floor((new Date() - arrivalForCurrent)/1000); // + => late
  if(diff <= 0){
    statusDiv.innerHTML = `<span class="ok">On Time ✅</span> &nbsp;(${formatDiffSec(Math.abs(diff))})`;
  } else {
    statusDiv.innerHTML = `<span class="danger">Late ❌</span> &nbsp;(-${formatDiffSec(diff)})`;
  }

  currentStopIndex++;
  if(currentStopIndex >= selectedRoute.stops.length){
    endRoute();
    return;
  }

  startStopTimerForIndex(currentStopIndex);

  // 10s delay before the bot announces the next station
  setTimeout(()=>{
    const routeNameToSend = selectedRouteName || 'Unknown route';
    const stationNameToSend = getStopName(selectedRoute.stops[currentStopIndex]) || 'Unknown station';
    fetch(`${DISCORD_BOT_ENDPOINT}/next-station`,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ routeName: routeNameToSend, stationName: stationNameToSend })
    }).catch(()=>{});
  }, 10000);
});

endBtn.addEventListener('click', endRoute);

function startStopTimerForIndex(idx){
  clearTimer();
  updateCurrentStation(idx);
  updateTimerDisplay();
  timerInterval = setInterval(updateTimerDisplay, 1000);
}
function updateCurrentStation(idx){
  const stationName = (selectedRoute && selectedRoute.stops[idx]) ? getStopName(selectedRoute.stops[idx]) : '';
  currentStationEl.textContent = stationName ? `Current station: ${stationName}` : '';
}
function updateTimerDisplay(){
  if(!selectedRoute || currentStopIndex >= selectedRoute.stops.length || !actualDepartureTime){
    timerDisplay.textContent = '--:--'; nextBtn.disabled = true; return;
  }
  const expected = new Date(actualDepartureTime.getTime() + currentStopIndex*60000);
  const diffSec = Math.ceil((expected - new Date())/1000);
  if(diffSec > 0){
    timerDisplay.style.background = 'var(--good)';
    timerDisplay.textContent = formatDiffSec(diffSec);
    nextBtn.disabled = diffSec > 15;
  } else {
    timerDisplay.style.background = 'var(--bad)';
    timerDisplay.textContent = '+' + formatDiffSec(Math.abs(diffSec)); // counts up when late
    nextBtn.disabled = false;
  }

  // refresh delta badges (avoid duplicates)
  const rows = tableBody.querySelectorAll('tr');
  rows.forEach((tr, i)=>{
    const tdTime = tr.children[1];
    const existing = tdTime.querySelector('.delta-badge');
    if(existing) existing.remove();

    const arrival = new Date(actualDepartureTime.getTime() + i*60000);
    const scheduledBase = getNextDeparture(new Date(), selectedRoute.freq);
    const scheduledArrival = new Date(scheduledBase.getTime() + i*60000);
    const deltaSec = Math.round((arrival - scheduledArrival)/1000);
    if(deltaSec !== 0){
      const deltaMin = Math.floor(Math.abs(deltaSec)/60);
      const deltaRem = Math.abs(deltaSec)%60;
      const sign = deltaSec>0? '+':'-';
      const span = document.createElement('span');
      span.className = 'delta-badge';
      span.style.marginLeft = '8px';
      span.style.fontSize = '12px';
      span.style.padding = '2px 6px';
      span.style.borderRadius = '6px';
      span.textContent = `${sign}${deltaMin}:${pad(deltaRem)}`;
      span.style.background = deltaSec > 0 ? 'rgba(228,63,90,0.12)' : 'rgba(28,200,138,0.06)';
      tdTime.appendChild(span);
    }
  });
}
function clearTimer(){
  if(timerInterval) clearInterval(timerInterval);
  timerInterval = null;
  timerDisplay.textContent = '--:--';
  nextBtn.disabled = true;
}
function endRoute(){
  clearTimer();
  statusDiv.textContent = 'Route completed!';
  currentStopIndex = 0;
  actualDepartureTime = null;
  currentStationEl.textContent = '';
  renderDynamicTimetable(selectedRoute, null);
}

/* ============================================================
   ADMIN ACTIONS
   ============================================================ */
createUserBtn.addEventListener('click', ()=>{
  const u = (newUsername.value || '').trim();
  const p = newPassword.value || '';
  if(!u || !p){ alert('Provide username and password'); return; }
  if(USERS[u]){ alert('User already exists'); return; }
  USERS[u] = { pw: p, admin: false };
  saveUsers(USERS); populateAdminLists();
  newUsername.value=''; newPassword.value='';
  alert(`Created user ${u}`);
});
giveStrikeBtn.addEventListener('click', ()=>{
  const u = strikeSelect.value;
  const amt = parseInt(strikeAmount.value || '1', 10);
  if(!u){ alert('Select user'); return; }
  STRIKES[u] = (STRIKES[u] || 0) + amt;
  saveStrikes(STRIKES); populateAdminLists();
  alert(`Gave ${amt} strike(s) to ${u}. Total: ${STRIKES[u]}`);
});
removeStrikeBtn.addEventListener('click', ()=>{
  const u = strikeSelect.value;
  if(!u){ alert('Select user'); return; }
  if(!STRIKES[u]){ alert(`${u} has no strikes`); return; }
  const amt = parseInt(strikeAmount.value || '1', 10);
  STRIKES[u] = Math.max(0, (STRIKES[u] || 0) - amt);
  saveStrikes(STRIKES); populateAdminLists();
  alert(`Removed ${amt} strike(s) from ${u}. Total: ${STRIKES[u]}`);
});
addRouteBtn.addEventListener('click', ()=>{
  const name = (newRouteName.value || '').trim();
  const freq = parseInt(newRouteFreq.value || '10', 10);
  const stopsRaw = (newRouteStops.value || '').trim();
  if(!name || !stopsRaw){ alert('Provide route name and stops'); return; }
  const stops = stopsRaw.split(/\r?\n|,/).map(s=>s.trim()).filter(Boolean).map(n=>({name:n}));
  ROUTES[name] = { freq: freq || 10, stops };
  const rev = name + ' 2';
  ROUTES[rev] = { freq: freq || 10, stops: [...stops].slice().reverse() };
  saveRoutes(ROUTES); populateRoutesSelect(); populateAdminLists();
  newRouteName.value=''; newRouteFreq.value=''; newRouteStops.value='';
});
function openEditRouteDialog(routeName){
  const r = ROUTES[routeName];
  if(!r) return alert('Route not found');
  const newName = prompt('Edit route name:', routeName); if(!newName) return;
  const newFreq = prompt('Frequency (minutes):', String(r.freq));
  const freqNum = parseInt(newFreq || String(r.freq),10) || r.freq;
  const stopsStr = prompt('Stops (one per line or comma separated):', r.stops.map(s=>getStopName(s)).join('\n'));
  if(!stopsStr) return;
  const stops = stopsStr.split(/\r?\n|,/).map(s=>s.trim()).filter(Boolean).map(n=>({name:n}));

  const oldRev = routeName.endsWith(' 2') ? routeName.replace(/ 2$/,'') : routeName + ' 2';
  delete ROUTES[routeName]; if(ROUTES[oldRev]) delete ROUTES[oldRev];

  ROUTES[newName] = { freq: freqNum, stops };
  ROUTES[newName + ' 2'] = { freq: freqNum, stops: [...stops].slice().reverse() };
  saveRoutes(ROUTES); populateRoutesSelect(); populateAdminLists();
  alert('Route updated');
}
refreshRoutesBtn.addEventListener('click', ()=>{
  ROUTES = loadRoutes(); populateRoutesSelect(); populateAdminLists();
});

/* ============================================================
   INIT
   ============================================================ */
function initUI(){
  populateRoutesSelect();
  populateAdminLists();
  renderActiveDrivers();
  renderLogs();
}
initUI();

/* ============================================================
   VERTREKTIJDEN PANEL
   ============================================================ */
const departuresPanel = document.createElement("div");
departuresPanel.id = "departuresPanel";
departuresPanel.style.cssText = `
  position:fixed; inset:0; background:rgba(0,0,0,.8);
  display:none; justify-content:center; align-items:center; z-index:9999;
`;
departuresPanel.innerHTML = `
  <div style="background:#0b1220; padding:20px; border-radius:12px; width:520px; max-height:80vh; overflow:auto;">
    <h2 style="margin-top:0;">Vertrektijden</h2>
    <table style="width:100%; border-collapse:collapse;">
      <thead><tr><th style="text-align:left;padding:8px;">Lijn</th><th style="text-align:left;padding:8px;">Locatie</th><th style="text-align:left;padding:8px;">Vertrektijd</th><th style="text-align:left;padding:8px;">In</th></tr></thead>
      <tbody id="departuresBody"></tbody>
    </table>
    <button id="closeDeparturesBtn" style="margin-top:12px;width:100%;background:#6c757d;">Sluiten</button>
  </div>
`;
document.body.appendChild(departuresPanel);

document.getElementById("openDeparturesBtn").addEventListener("click", ()=>{
  departuresPanel.style.display = "flex";
  renderDepartures();
});
document.getElementById("closeDeparturesBtn").addEventListener("click", ()=>{
  departuresPanel.style.display = "none";
});

async function renderDepartures(){
  const tbody = document.getElementById("departuresBody");
  tbody.innerHTML = "<tr><td colspan='4' style='text-align:center;color:#aaa;padding:10px;'>Laden...</td></tr>";
  try{
    const res = await fetch(`${DISCORD_BOT_ENDPOINT}/departures`);
    const stored = await res.json();
    tbody.innerHTML = "";
    const nowDate = new Date();
    if(!stored.length){
      tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:#aaa; padding:10px;">Geen actieve lijnen</td></tr>`;
      return;
    }
    stored.forEach(dep=>{
      const tr = document.createElement("tr");
      const mins = Math.max(0, Math.floor((new Date(dep.time) - nowDate)/60000));
      tr.innerHTML = `
        <td style="padding:8px;">${dep.line}</td>
        <td style="padding:8px;">${dep.stop}</td>
        <td style="padding:8px;">${new Date(dep.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</td>
        <td style="padding:8px;">${mins} min</td>`;
      tbody.appendChild(tr);
    });
  }catch(err){
    tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:#f66; padding:10px;">Fout bij laden</td></tr>`;
    console.error("Fout bij ophalen vertrektijden:", err);
  }
}
async function registerDeparture(lineName, stopName, departTime){
  try{
    await fetch(`${DISCORD_BOT_ENDPOINT}/departures`,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ line: lineName, stop: stopName, time: departTime })
    });
  }catch(err){
    console.error("Fout bij verzenden vertrektijd:", err);
  }
}
</script>
</body>
</html>

