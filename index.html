<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ERLC Bus Scheduler</title>
<style>
  body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #a8edea, #fed6e3); margin:0; padding:0; display:flex; flex-direction:column; align-items:center; min-height:100vh; }
  h1,h2 { margin:0 0 10px 0; text-align:center; color:#333; }
  .container { display:flex; flex-wrap:wrap; justify-content:center; gap:20px; padding:40px 20px; width:100%; max-width:1200px; }
  .card { background:white; border-radius:16px; padding:25px; box-shadow:0 10px 25px rgba(0,0,0,0.1); width:320px; display:flex; flex-direction:column; align-items:center; }
  input, select, button { width:100%; padding:10px; margin:8px 0; border-radius:12px; border:1px solid #ccc; font-size:16px; }
  button { background:#ff7e5f; color:white; border:none; cursor:pointer; font-weight:bold; transition:0.3s; }
  button:hover { background:#eb6750; }
  .info { margin:12px 0; width:100%; text-align:center; }
  .label { font-weight:bold; color:#555; }
  .big { font-size:22px; color:#ff7e5f; }
  .timetable { width:100%; max-width:400px; background:#fefefe; border-radius:16px; padding:20px; box-shadow:0 10px 25px rgba(0,0,0,0.1); }
  table { width:100%; border-collapse:collapse; }
  th, td { padding:8px; text-align:left; border-bottom:1px solid #eee; }
  th { background:#ff7e5f; color:white; border-radius:8px; }
</style>
</head>
<body>

<h1>ERLC Bus Scheduler</h1>

<div class="container">
  <!-- LOGIN -->
  <div class="card" id="loginCard">
    <h2>Login</h2>
    <input type="text" id="username" placeholder="Username">
    <input type="password" id="password" placeholder="Password">
    <button id="loginBtn">Login</button>
    <div id="loginMsg" style="color:red; margin-top:10px;"></div>
  </div>

  <!-- BUS CONTROLS -->
  <div class="card" id="busCard" style="display:none;">
    <h2>Bus Schedule</h2>
    <select id="lineSelect"></select>
    <button id="confirmBtn">Load Timetable</button>
    <button id="departBtn" disabled>Depart</button>
    <button id="nextBtn" disabled>Next Station</button>
    <button id="endBtn" disabled>End</button>

    <div class="info"><span class="label">Current Time:</span><br><span id="currentTime" class="big"></span></div>
    <div class="info"><span class="label">Next Departure:</span><br><span id="nextDeparture" class="big"></span></div>
    <div class="info"><span class="label">Countdown:</span><br><span id="countdown" class="big"></span></div>
    <div class="info"><span class="label">Status:</span><br><span id="status" class="big"></span></div>
  </div>

  <!-- TIMETABLE -->
  <div class="timetable" id="timetableCard" style="display:none;">
    <h2 id="tableTitle">Timetable</h2>
    <table>
      <thead><tr><th>Stop</th><th>Arrival</th><th>Late</th></tr></thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
</div>

<script>
const DISCORD_WEBHOOK_URL = "YOUR_WEBHOOK_URL_HERE";

// === USERS DATABASE ===
const users = {
  "pwatg123admin": { pw: "utrechtov20092025", admin:true },
  "Roidkyadmin":   { pw: "Mohamed4obai", admin:true },
  "Roidky":   { pw: "Mohamed4obai", admin:false },
  "pwatg123":   { pw: "utrechtov20092025", admin:false },
  "ilias4real.": { pw: "OVIlias239", admin:false },
  "milandepro7": { pw: "Utrechtov20702025", admin:false },
  "driver": { pw: "pass123", admin:false }
};

// === BUS LINES ===
const lines = {
  "Line A": { freq:10, stops:[ "Spawn","Brandweer Kazerene","Central Park","Centraal Station","Maple Valley Farms","Highrock Park" ] },
  "Event Shuttle": { freq:15, stops:[ "Spawn","Event Center" ] },
  "Line B": { freq:15, stops:[ "Central Park","Ouchard Boulevard","Ouchard Boulevard 2","Central Park","Medical Way","Maple Valley Farms","Highrock Park" ] },
  "Line C": { freq:10, stops:[ "Spawn","Chinatown","Fire Department","Central Park","Hospital","Farms","Highrock","Springfield" ] }
};

const loginCard = document.getElementById("loginCard");
const busCard = document.getElementById("busCard");
const timetableCard = document.getElementById("timetableCard");
const loginBtn = document.getElementById("loginBtn");
const usernameEl = document.getElementById("username");
const passwordEl = document.getElementById("password");
const loginMsg = document.getElementById("loginMsg");
const select = document.getElementById("lineSelect");
const confirmBtn = document.getElementById("confirmBtn");
const departBtn = document.getElementById("departBtn");
const nextBtn = document.getElementById("nextBtn");
const endBtn = document.getElementById("endBtn");
const currentTimeEl = document.getElementById("currentTime");
const nextDepartureEl = document.getElementById("nextDeparture");
const countdownEl = document.getElementById("countdown");
const statusEl = document.getElementById("status");
const tableBody = document.getElementById("tableBody");
const tableTitle = document.getElementById("tableTitle");

let CURRENT_USER = null;
let selectedLine = null;
let departTime = null;
let currentStopIndex = 0;
let timerInterval = null;

// LOGIN
loginBtn.addEventListener("click", ()=> {
  const username = usernameEl.value;
  const password = passwordEl.value;
  if(users[username] && users[username].pw === password){
    CURRENT_USER = username;
    loginCard.style.display="none";
    busCard.style.display="block";
    timetableCard.style.display="block";
    populateLines();
    loginMsg.textContent="";
  } else {
    loginMsg.textContent="Invalid username or password!";
  }
});

function populateLines(){
  select.innerHTML="";
  Object.keys(lines).forEach(l=>{
    const opt = document.createElement("option");
    opt.value = l; opt.textContent = l;
    select.appendChild(opt);
  });
}

confirmBtn.addEventListener("click", ()=>{
  selectedLine = lines[select.value];
  tableTitle.textContent = select.value;
  generateTimetable(selectedLine);
  departBtn.disabled=false;
  nextBtn.disabled=true;
  endBtn.disabled=true;
  departTime = null;
  currentStopIndex = 0;
});

function getNextDeparture(now,freq){
  const mins=now.getMinutes();
  const rem=mins%freq;
  const next=new Date(now);
  const add=rem===0?freq:freq-rem;
  next.setMinutes(mins+add);
  next.setSeconds(0,0);
  return next;
}

function generateTimetable(line){
  tableBody.innerHTML="";
  const nextDep=getNextDeparture(new Date(),line.freq);
  line.stops.forEach((stop,i)=>{
    const tr=document.createElement("tr");
    const tdStop=document.createElement("td"); tdStop.textContent=stop;
    const tdTime=document.createElement("td"); 
    const arrival = new Date(nextDep.getTime()+i*60000);
    tdTime.textContent=arrival.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    const tdLate = document.createElement("td"); tdLate.textContent='';
    tr.append(tdStop,tdTime,tdLate);
    tableBody.appendChild(tr);
  });
}

// DEPART
departBtn.addEventListener("click", ()=>{
  if(!selectedLine) return;
  departTime = new Date();
  currentStopIndex = 0;
  startTimer();
  departBtn.disabled=true;
  nextBtn.disabled=false;
  endBtn.disabled=false;
  updateTimetableOnDepart();
  statusEl.textContent = `Departed from ${selectedLine.stops[0]}`;
  logShift(CURRENT_USER, select.value, departTime);
});

// NEXT
nextBtn.addEventListener("click", ()=>{
  if(!departTime) return;
  const now = new Date();
  const expected = new Date(departTime.getTime() + currentStopIndex*60000);
  const diffSec = Math.floor((now-expected)/1000);
  const late = diffSec>0;
  const tdLate = tableBody.rows[currentStopIndex].cells[2];
  tdLate.textContent = late? `+${diffSec}s late` : '';
  tdLate.style.color = late?'red':'green';

  currentStopIndex++;
  if(currentStopIndex>=selectedLine.stops.length){
    endRoute();
  } else {
    statusEl.textContent = `Arrived at ${selectedLine.stops[currentStopIndex]}`;
  }
});

// END
endBtn.addEventListener("click", endRoute);

function endRoute(){
  clearInterval(timerInterval);
  statusEl.textContent = "Route ended";
  departBtn.disabled=false;
  nextBtn.disabled=true;
  endBtn.disabled=true;
  departTime=null;
  currentStopIndex=0;
}

// UPDATE TIMETABLE BASED ON ACTUAL DEPART
function updateTimetableOnDepart(){
  for(let i=0;i<selectedLine.stops.length;i++){
    const arrival = new Date(departTime.getTime()+i*60000);
    tableBody.rows[i].cells[1].textContent = arrival.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
  }
}

// TIMER
function startTimer(){
  timerInterval = setInterval(()=>{
    const now = new Date();
    currentTimeEl.textContent = now.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});
    if(departTime){
      const nextDep = new Date(departTime.getTime() + currentStopIndex*60000);
      nextDepartureEl.textContent = nextDep.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
      const diffSec = Math.floor((nextDep-now)/1000);
      countdownEl.textContent = diffSec>0 ? diffSec+'s':'0s';
    }
  },1000);
}

// SHIFT LOGS + DISCORD
let LOGS = [];
function logShift(user,line,depart){
  const entry = {user, line, departTime: depart.toISOString()};
  LOGS.unshift(entry);
  sendShiftLogToDiscord(entry.user, entry.line, entry.departTime);
}

function sendShiftLogToDiscord(user,line,time){
  if(!DISCORD_WEBHOOK_URL) return;
  fetch(DISCORD_WEBHOOK_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({content:`Shift started: **${user}** on line **${line}** at **${time}**`})
  });
}
</script>
</body>
</html>
