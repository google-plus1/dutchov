<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ERLC Bus Scheduler</title>
<style>
:root{
  --bg:#0f1724; --card:#0b1220; --accent:#ff6b6b; --muted:#9aa4c0;
  --good:#1cc88a; --bad:#e43f5a; --panel:#0f3460;
}
*{box-sizing:border-box;}
body{
  margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
  background:linear-gradient(180deg,#071024 0%, #0e1530 100%); color:#edf2f7;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}
header{padding:18px 24px;border-bottom:1px solid rgba(255,255,255,.03);display:flex;align-items:center;gap:12px;}
h1{margin:0;font-size:18px;}
.wrap{display:flex;gap:20px;padding:20px;max-width:1200px;margin:20px auto;}
.card{background:var(--card);border-radius:12px;padding:18px;width:360px;box-shadow:0 6px 30px rgba(2,6,23,.6);}
.wide{flex:1;min-width:360px;padding:18px;}
label{display:block;font-size:13px;color:var(--muted);margin-top:8px;}
input,select,textarea,button{width:100%;padding:10px;border-radius:8px;border:0;font-size:14px;}
textarea{min-height:88px;resize:vertical;}
button{background:var(--accent);color:#fff;border:0;cursor:pointer;}
.muted{color:var(--muted);font-size:13px;}
.infoRow{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:10px;}
.big{font-weight:700;font-size:18px;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,.03);font-size:14px;}
th{color:#fff;background:linear-gradient(90deg,var(--accent),#ff907a);border-radius:6px;}
.smallBtn{padding:6px 8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,.06);color:var(--muted);cursor:pointer;}
#activeDrivers{position:fixed;left:18px;bottom:18px;background:var(--panel);padding:12px;border-radius:10px;min-width:200px;box-shadow:0 8px 30px rgba(0,0,0,.6);}
#activeDrivers h3{margin:0 0 6px 0;color:var(--good);font-size:14px;}
.timer{margin-top:12px;padding:10px;border-radius:8px;text-align:center;font-weight:700;font-size:20px;color:#fff;background:var(--good);min-width:120px;}
.status{margin-top:8px;font-weight:600;}
.adminPanel{background:#07183a;padding:12px;border-radius:10px;}
.row{display:flex;gap:8px;}
.row > *{flex:1;}
.mutedSmall{font-size:12px;color:var(--muted);}
.logItem{display:flex;justify-content:space-between;gap:10px;align-items:center;padding:8px;border-radius:6px;background:rgba(255,255,255,.02);margin-bottom:8px;}
.danger{background:rgba(228,63,90,.08);border:1px solid rgba(228,63,90,.12);color:var(--bad);padding:6px 8px;border-radius:8px;}
.ok{background:rgba(28,200,138,.06);border:1px solid rgba(28,200,138,.12);color:var(--good);padding:6px 8px;border-radius:8px;}
.inlineSmall{display:inline-block;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,.02);color:var(--muted);font-size:13px;}
</style>
</head>
<body>

<header>
<h1>ERLC Bus Scheduler</h1>
<div style="margin-left:auto" class="mutedSmall">Local demo — data saved in browser storage</div>
</header>

<div class="wrap">

<!-- Login & Driver Controls -->
<div class="card">
  <div id="loginSection">
    <h2 style="margin:0 0 8px 0">Login</h2>
    <label>Username</label>
    <input id="username" placeholder="username" />
    <label>Password</label>
    <input id="password" type="password" placeholder="password" />
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="loginBtn">Login</button>
      <button id="logoutBtn" style="display:none;background:#6c757d">Logout</button>
    </div>
    <div id="loginMsg" class="mutedSmall" style="margin-top:8px;color:#ffb4b4"></div>
  </div>

  <div id="driverControls" style="display:none;margin-top:12px">
    <h3 style="margin:0 0 8px 0">Driver Controls</h3>
    <label>Choose Line</label>
    <select id="lineSelect"></select>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="confirmBtn">Load Timetable</button>
      <button id="reverseBtn" title="Toggle original/return" class="smallBtn">Reverse</button>
    </div>
    <div class="infoRow">
      <div>
        <div class="mutedSmall">Current time</div>
        <div id="currentTime" class="big"></div>
      </div>
      <div style="text-align:right">
        <div class="mutedSmall">Next departure</div>
        <div id="nextDeparture" class="big">--:--</div>
      </div>
    </div>
    <div style="margin-top:10px">
      <div class="mutedSmall">Countdown to next departure</div>
      <div id="countdown" class="timer">--:--</div>
    </div>
    <div id="stationControls" style="display:none;margin-top:12px">
      <div style="display:flex;gap:8px">
        <button id="departBtn">Depart</button>
        <button id="nextBtn" disabled>Next Station</button>
        <button id="endBtn">End</button>
      </div>
      <div id="timerDisplay" class="timer" style="margin-top:10px;background:var(--good)">--:--</div>
      <div id="status" class="status mutedSmall"></div>
      <div style="margin-top:8px" class="mutedSmall">*Next Station button only in last 15s before arrival or when late.</div>
    </div>
    <div style="margin-top:12px">
      <div class="mutedSmall">Current Station:</div>
      <div id="currentStation" class="big">--</div>
    </div>
  </div>
</div>

<!-- Timetable & Admin -->
<div class="wide card" style="min-width:520px">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <h2 style="margin:0">Timetable & Admin</h2>
    <div id="userBadge" class="inlineSmall" style="display:none"></div>
  </div>
  <div id="timetableCard" style="margin-top:12px; display:none">
    <div class="mutedSmall">Timetable for <strong id="tableTitle"></strong></div>
    <table id="timetableTable">
      <thead><tr><th>Stop</th><th>Arrival</th></tr></thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanel" style="margin-top:16px;display:none" class="adminPanel">
    <h3 style="margin:0 0 8px 0;color:var(--good)">Admin Panel</h3>
    <div style="display:flex;gap:10px">
      <div style="flex:1">
        <label>New Route name</label>
        <input id="newRouteName" placeholder="e.g. Line X" />
        <label>Frequency (minutes)</label>
        <input id="newRouteFreq" placeholder="10" />
        <label>Stops (comma separated)</label>
        <textarea id="newRouteStops" placeholder="Spawn, Chinatown, Fire Department"></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="addRouteBtn">Add Route</button>
        </div>
        <hr>
        <label>Create User</label>
        <input id="newUserName" placeholder="username" />
        <input id="newUserPassword" placeholder="password" />
        <select id="newUserAdmin">
          <option value="false">Driver</option>
          <option value="true">Admin</option>
        </select>
        <button id="createUserBtn">Create User</button>
      </div>
      <div style="width:260px">
        <div class="mutedSmall">Routes</div>
        <div id="routesList" style="margin-top:8px;max-height:280px;overflow:auto"></div>
        <hr>
        <div class="mutedSmall">Shift Logs</div>
        <div id="logsList" style="margin-top:8px;max-height:220px;overflow:auto"></div>
      </div>
    </div>
  </div>
</div>

<!-- Active Drivers -->
<div id="activeDrivers" style="display:none">
<h3>Active Drivers</h3>
<ul id="driversList" style="margin:0;padding-left:18px"></ul>
</div>

<script>
/* ------------------------- Storage & Data ------------------------- */
const STORAGE_ROUTES = 'erlc_routes_v2';
const STORAGE_LOGS = 'erlc_logs_v2';
const STORAGE_USERS = 'erlc_users_v2';

const defaultUsers = {
  "pwatg123admin": { pw: "utrechtov20092025", admin:true, strikes:0 },
  "Roidkyadmin": { pw: "Mohamed4obai", admin:true, strikes:0 },
  "Roidky": { pw: "Mohamed4obai", admin:false, strikes:0 },
  "pwatg123": { pw: "utrechtov20092025", admin:false, strikes:0 },
  "Ilias123": { pw: "Pass123", admin:false, strikes:0 },
  "milandepro7": { pw: "Utrechtov20702025", admin:false, strikes:0 },
  "blobvisje.": { pw: "pass123", admin:false, strikes:0 }
};

const defaultRoutes = {
  "Line A": { freq:10, stops:[ "Spawn","Chinatown","Central Park","Highrock" ] },
  "Line C": { freq:10, stops:[ "Spawn","Chinatown","Fire Department","Central Park","Hospital","Farms","Highrock","Springfield" ] },
  "FastLine": { freq:8, stops:[ "Springfield","River City" ] }
};

/* ------------------------- Load/Save ------------------------- */
function saveUsers(users){ localStorage.setItem(STORAGE_USERS, JSON.stringify(users)); }
function loadUsers(){ let u=localStorage.getItem(STORAGE_USERS); if(!u){ saveUsers(defaultUsers); return defaultUsers; } return JSON.parse(u); }

function saveRoutes(routes){ localStorage.setItem(STORAGE_ROUTES, JSON.stringify(routes)); ROUTES=routes; }
function loadRoutes(){ let r=localStorage.getItem(STORAGE_ROUTES); if(!r){ saveRoutes(defaultRoutes); return defaultRoutes; } return JSON.parse(r); }

function saveLogs(l){ localStorage.setItem(STORAGE_LOGS, JSON.stringify(l)); LOGS=l; }
function loadLogs(){ let l=localStorage.getItem(STORAGE_LOGS); return l?JSON.parse(l):[]; }

let USERS=loadUsers();
let ROUTES=loadRoutes();
let LOGS=loadLogs();
let activeDrivers = {};
let CURRENT_USER=null;
let CURRENT_USER_IS_ADMIN=false;
let selectedRouteName=null;
let selectedRoute=null;
let useReverse=false;
let actualDepartureTime=null;
let currentStopIndex=0;
let timerInterval=null;

/* ------------------------- DOM ------------------------- */
const usernameEl=document.getElementById('username');
const passwordEl=document.getElementById('password');
const loginBtn=document.getElementById('loginBtn');
const logoutBtn=document.getElementById('logoutBtn');
const loginMsg=document.getElementById('loginMsg');
const driverControls=document.getElementById('driverControls');
const lineSelect=document.getElementById('lineSelect');
const confirmBtn=document.getElementById('confirmBtn');
const reverseBtn=document.getElementById('reverseBtn');
const currentTime=document.getElementById('currentTime');
const nextDeparture=document.getElementById('nextDeparture');
const countdown=document.getElementById('countdown');
const stationControls=document.getElementById('stationControls');
const departBtn=document.getElementById('departBtn');
const nextBtn=document.getElementById('nextBtn');
const endBtn=document.getElementById('endBtn');
const timerDisplay=document.getElementById('timerDisplay');
const statusDiv=document.getElementById('status');
const tableTitle=document.getElementById('tableTitle');
const tableBody=document.getElementById('tableBody');
const timetableCard=document.getElementById('timetableCard');
const userBadge=document.getElementById('userBadge');
const adminPanel=document.getElementById('adminPanel');
const routesList=document.getElementById('routesList');
const logsList=document.getElementById('logsList');
const activeDriversDiv=document.getElementById('activeDrivers');
const driversList=document.getElementById('driversList');
const currentStation=document.getElementById('currentStation');
const addRouteBtn=document.getElementById('addRouteBtn');
const newRouteName=document.getElementById('newRouteName');
const newRouteFreq=document.getElementById('newRouteFreq');
const newRouteStops=document.getElementById('newRouteStops');
const newUserName=document.getElementById('newUserName');
const newUserPassword=document.getElementById('newUserPassword');
const newUserAdmin=document.getElementById('newUserAdmin');
const createUserBtn=document.getElementById('createUserBtn');

/* ------------------------- Utils ------------------------- */
function now(){ return new Date(); }
function formatTime(d){ return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }
function formatDiffSec(s){ s=Math.floor(Math.abs(s)); const mm=Math.floor(s/60).toString().padStart(2,'0'); const ss=(s%60).toString().padStart(2,'0'); return `${mm}:${ss}`; }

/* ------------------------- Login ------------------------- */
loginBtn.addEventListener('click', ()=>{
  const u=usernameEl.value.trim(), p=passwordEl.value;
  loginMsg.textContent='';
  if(!u||!p){ loginMsg.textContent='Enter username & password'; return; }
  const userRecord=USERS[u];
  if(!userRecord||userRecord.pw!==p){ loginMsg.textContent='Invalid username or password'; return; }
  CURRENT_USER=u; CURRENT_USER_IS_ADMIN=userRecord.admin;
  loginMsg.textContent='';
  document.getElementById('loginSection').style.display='none';
  driverControls.style.display='block';
  logoutBtn.style.display='inline-block';
  userBadge.style.display='inline-block';
  userBadge.textContent=`${CURRENT_USER}${CURRENT_USER_IS_ADMIN?' (admin)':''}`;
  populateRoutesSelect();
  if(CURRENT_USER_IS_ADMIN){ adminPanel.style.display='block'; populateAdminRoutes(); populateLogs(); }
  addActiveDriver(CURRENT_USER);
});

logoutBtn.addEventListener('click', ()=>{
  CURRENT_USER=null; CURRENT_USER_IS_ADMIN=false;
  document.getElementById('loginSection').style.display='block';
  driverControls.style.display='none';
  adminPanel.style.display='none';
  timetableCard.style.display='none';
  stationControls.style.display='none';
  activeDriversDiv.style.display='none';
  logoutBtn.style.display='none';
  userBadge.style.display='none';
  clearTimer();
});

/* ------------------------- Active Drivers ------------------------- */
function addActiveDriver(name){
  if(!activeDrivers[name]) activeDrivers[name]=true;
  renderActiveDrivers();
}
function removeActiveDriver(name){
  delete activeDrivers[name]; renderActiveDrivers();
}
function renderActiveDrivers(){
  driversList.innerHTML='';
  for(const d in activeDrivers){
    const li=document.createElement('li'); li.textContent=d; driversList.appendChild(li);
  }
  activeDriversDiv.style.display=Object.keys(activeDrivers).length?'block':'none';
}

/* ------------------------- Routes ------------------------- */
function populateRoutesSelect(){
  lineSelect.innerHTML='';
  Object.keys(ROUTES).sort().forEach(n=>{
    const opt=document.createElement('option'); opt.value=n; opt.textContent=n; lineSelect.appendChild(opt);
  });
  if(Object.keys(ROUTES).length) lineSelect.value=Object.keys(ROUTES)[0];
}

confirmBtn.addEventListener('click', ()=>{
  const routeName=lineSelect.value;
  if(activeDrivers[routeName]&&activeDrivers[routeName]!==CURRENT_USER){    alert(`Route "${routeName}" is currently driven by another driver.`); 
    return; 
  }
  selectedRouteName = routeName; 
  useReverse = false; 
  loadSelectedRoute();
});

/* Reverse Route */
reverseBtn.addEventListener('click', ()=>{
  if(!selectedRouteName) return; 
  useReverse = !useReverse; 
  loadSelectedRoute();
});

/* Load Route Timetable */
function loadSelectedRoute(){
  if(!selectedRouteName) return;
  let name = selectedRouteName;
  selectedRoute = ROUTES[name];
  if(useReverse){
    const revName = name.endsWith(' 2') ? name.replace(/ 2$/,'') : name+' 2';
    if(ROUTES[revName]) { selectedRoute = ROUTES[revName]; name = revName; }
  }
  if(!selectedRoute) return;

  // Calculate next departure based on frequency
  const nowTime = now();
  const freq = selectedRoute.freq;
  const minutes = nowTime.getMinutes();
  const nextDepMin = Math.ceil(minutes / freq) * freq;
  const depTime = new Date(nowTime);
  depTime.setMinutes(nextDepMin,0,0);
  actualDepartureTime = depTime; // show on timetable immediately

  tableTitle.textContent = name;
  renderDynamicTimetable(selectedRoute, depTime);
  timetableCard.style.display='block';
  stationControls.style.display='block';
  nextDeparture.textContent = formatTime(depTime);
  currentStopIndex = 0;
  currentStation.textContent = selectedRoute.stops[currentStopIndex];
  clearTimer();
}

/* Dynamic Timetable */
function renderDynamicTimetable(route, departTime){
  tableBody.innerHTML='';
  route.stops.forEach((stop,i)=>{
    const tr=document.createElement('tr');
    const tdStop=document.createElement('td'); tdStop.textContent=stop;
    const tdTime=document.createElement('td');
    tdTime.textContent = departTime ? formatTime(new Date(departTime.getTime() + i*60000)) : '--:--';
    tr.appendChild(tdStop); tr.appendChild(tdTime);
    tableBody.appendChild(tr);
  });
}

/* ------------------------- Depart & Timer ------------------------- */
departBtn.addEventListener('click', ()=>{
  if(!selectedRoute) { alert('Load a route first'); return; }
  currentStopIndex = 0;
  logShift(CURRENT_USER, tableTitle.textContent || lineSelect.value);
  startStopTimerForIndex(currentStopIndex);
  statusDiv.textContent = `Departed: ${selectedRoute.stops[currentStopIndex]}`;
});

nextBtn.addEventListener('click', ()=>{
  if(!selectedRoute || !actualDepartureTime) return;
  const expected = new Date(actualDepartureTime.getTime() + currentStopIndex*60000);
  const secRemaining = Math.ceil((expected - now())/1000);
  if(secRemaining>15){ statusDiv.textContent=`Next Station only in last 15s before arrival (${secRemaining}s left)`; return; }

  const diff = Math.floor((now()-expected)/1000);
  if(diff<=0){ statusDiv.innerHTML=`<span class="ok">On Time ✅</span> &nbsp;(${formatDiffSec(Math.abs(diff))})`; }
  else { statusDiv.innerHTML=`<span class="danger">Late ❌</span> &nbsp;(-${formatDiffSec(diff)})`; }

  currentStopIndex++;
  if(currentStopIndex>=selectedRoute.stops.length){ endRoute(); return; }

  startStopTimerForIndex(currentStopIndex);
});

endBtn.addEventListener('click', endRoute);

function startStopTimerForIndex(idx){
  clearTimer();
  timerInterval=setInterval(updateTimerDisplay,1000);
  updateTimerDisplay();
}

function updateTimerDisplay(){
  if(!selectedRoute || currentStopIndex>=selectedRoute.stops.length || !actualDepartureTime){
    timerDisplay.textContent='--:--'; nextBtn.disabled=true; return;
  }
  const expected = new Date(actualDepartureTime.getTime() + currentStopIndex*60000);
  let diffSec = Math.ceil((expected-now())/1000);
  if(diffSec>0){ timerDisplay.style.background='var(--good)'; timerDisplay.textContent=formatDiffSec(diffSec); nextBtn.disabled=diffSec>15; }
  else { timerDisplay.style.background='var(--bad)'; timerDisplay.textContent='-'+formatDiffSec(Math.abs(diffSec)); nextBtn.disabled=false; }
  currentStation.textContent = selectedRoute.stops[currentStopIndex];
}

function clearTimer(){ if(timerInterval) clearInterval(timerInterval); timerInterval=null; timerDisplay.textContent='--:--'; nextBtn.disabled=true; }
function endRoute(){ clearTimer(); statusDiv.textContent='Route completed!'; currentStopIndex=0; actualDepartureTime=null; renderDynamicTimetable(selectedRoute,null); removeActiveDriver(CURRENT_USER); }

/* ------------------------- Shift Logs ------------------------- */
function logShift(user, routeName){
  const entry={user,route:routeName,time:new Date().toISOString()};
  LOGS.unshift(entry); saveLogs(LOGS);
  if(CURRENT_USER_IS_ADMIN) populateLogs();
}
function populateLogs(){
  logsList.innerHTML=''; if(!LOGS.length){ logsList.textContent='No shift logs'; return; }
  LOGS.forEach((l,idx)=>{
    const wrap=document.createElement('div'); wrap.className='logItem';
    const left=document.createElement('div');
    left.innerHTML=`<strong>${l.user}</strong> - ${l.route} <div class="mutedSmall">${new Date(l.time).toLocaleString()}</div>`;
    const right=document.createElement('div');
    const del=document.createElement('button'); del.className='smallBtn'; del.textContent='Delete';
    del.addEventListener('click',()=>{ if(confirm('Delete this log?')){ LOGS.splice(idx,1); saveLogs(LOGS); populateLogs(); } });
    right.appendChild(del); wrap.appendChild(left); wrap.appendChild(right); logsList.appendChild(wrap);
  });
}

/* ------------------------- Admin: Routes ------------------------- */
function populateAdminRoutes(){
  routesList.innerHTML='';
  Object.keys(ROUTES).sort().forEach(n=>{
    const div=document.createElement('div'); div.style.display='flex'; div.style.justifyContent='space-between'; div.style.alignItems='center'; div.style.marginBottom='8px';
    const left=document.createElement('div'); left.innerHTML=`<strong>${n}</strong> <div class="mutedSmall">${ROUTES[n].freq} min — ${ROUTES[n].stops.length} stops</div>`;
    const right=document.createElement('div');
    const delBtn=document.createElement('button'); delBtn.className='smallBtn'; delBtn.textContent='Delete';
    delBtn.addEventListener('click',()=>{ if(confirm(`Delete route "${n}"?`)){ delete ROUTES[n]; saveRoutes(ROUTES); populateAdminRoutes(); populateRoutesSelect(); } });
    right.appendChild(delBtn); div.appendChild(left); div.appendChild(right); routesList.appendChild(div);
  });
}

addRouteBtn.addEventListener('click', ()=>{
  const name=newRouteName.value.trim(), freq=parseInt(newRouteFreq.value.trim()), stops=newRouteStops.value.split(',').map(s=>s.trim()).filter(Boolean);
  if(!name||!freq||stops.length<2){ alert('Fill name, freq and at least 2 stops'); return; }
  ROUTES[name]={freq,stops}; ROUTES[name+' 2']={freq,stops:[...stops].reverse()}; saveRoutes(ROUTES); populateAdminRoutes(); populateRoutesSelect();
  newRouteName.value=''; newRouteFreq.value=''; newRouteStops.value='';
});

/* ------------------------- Admin: Create Users ------------------------- */
createUserBtn.addEventListener('click', ()=>{
  const u=newUserName.value.trim(), p=newUserPassword.value.trim(), adminFlag=newUserAdmin.value==='true';
  if(!u||!p){ alert('Fill username and password'); return; }
  if(USERS[u]){ alert('Username exists'); return; }
  USERS[u]={pw:p, admin:adminFlag, strikes:0}; saveUsers(USERS);
  newUserName.value=''; newUserPassword.value=''; newUserAdmin.value='false';
  alert(`User ${u} created!`);
});

/* ------------------------- Active Drivers Render ------------------------- */
function renderActiveDrivers(){
  driversList.innerHTML=''; for(const d in activeDrivers){ const li=document.createElement('li'); li.textContent=d; driversList.appendChild(li); }
  activeDriversDiv.style.display=Object.keys(activeDrivers).length?'block':'none';
}

/* ------------------------- Clock ------------------------- */
setInterval(()=>{ currentTime.textContent=now().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'}); },1000);

</script>
</body>
</html>

   
