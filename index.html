<script>
/* -------------------------
   Storage helpers & init
------------------------- */
const STORAGE_ROUTES = 'erlc_routes_v2';
const STORAGE_LOGS = 'erlc_logs_v2';
const STORAGE_USERS = 'erlc_users_v2';

const defaultUsers = {
  "pwatg123admin": { pw: "utrechtov20092025", admin:true },
  "Roidkyadmin":   { pw: "Mohamed4obai", admin:true },
  "Roidky":        { pw: "Mohamed4obai", admin:false },
  "pwatg123":      { pw: "utrechtov20092025", admin:false },
  "ilias4real.":   { pw: "OVIlias239", admin:false },
  "milandepro7":   { pw: "Utrechtov20702025", admin:false },
  "driver":        { pw: "pass123", admin:false }
};

const defaultRoutes = {
  "Line A": { freq:10, stops:[ "Spawn","Chinatown","Central Park","Highrock" ] },
  "Line C": { freq:10, stops:[ "Spawn","Chinatown","Fire Department","Central Park","Hospital","Farms","Highrock","Springfield" ] },
  "FastLine": { freq:8, stops:[ "Springfield","River City" ] }
};

function saveRoutes(routes){ localStorage.setItem(STORAGE_ROUTES, JSON.stringify(routes)); ROUTES = routes; }
function loadRoutes(){
  let r = localStorage.getItem(STORAGE_ROUTES);
  if(!r){
    const temp = JSON.parse(JSON.stringify(defaultRoutes));
    for(const name in defaultRoutes){
      const revName = name+" 2";
      temp[revName] = { freq: defaultRoutes[name].freq, stops:[...defaultRoutes[name].stops].reverse() };
    }
    saveRoutes(temp);
    return temp;
  }
  return JSON.parse(r);
}

function saveUsers(users){ localStorage.setItem(STORAGE_USERS, JSON.stringify(users)); USERS = users; }
function loadUsers(){
  let u = localStorage.getItem(STORAGE_USERS);
  if(!u){ saveUsers(defaultUsers); return defaultUsers; }
  return JSON.parse(u);
}

function saveLogs(l){ localStorage.setItem(STORAGE_LOGS, JSON.stringify(l)); LOGS = l; }
function loadLogs(){ let l = localStorage.getItem(STORAGE_LOGS); return l?JSON.parse(l):[]; }

let ROUTES = loadRoutes();
let LOGS = loadLogs();
let USERS = loadUsers();

/* -------------------------
   DOM elements
------------------------- */
const usernameEl = document.getElementById('username');
const passwordEl = document.getElementById('password');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const loginMsg = document.getElementById('loginMsg');

const driverControls = document.getElementById('driverControls');
const lineSelect = document.getElementById('lineSelect');
const confirmBtn = document.getElementById('confirmBtn');
const reverseBtn = document.getElementById('reverseBtn');

const currentTime = document.getElementById('currentTime');
const nextDeparture = document.getElementById('nextDeparture');
const countdown = document.getElementById('countdown');

const stationControls = document.getElementById('stationControls');
const departBtn = document.getElementById('departBtn');
const nextBtn = document.getElementById('nextBtn');
const endBtn = document.getElementById('endBtn');
const timerDisplay = document.getElementById('timerDisplay');
const statusDiv = document.getElementById('status');

const timetableCard = document.getElementById('timetableCard');
const tableTitle = document.getElementById('tableTitle');
const tableBody = document.getElementById('tableBody');

const activeDriversDiv = document.getElementById('activeDrivers');
const driversList = document.getElementById('driversList');
const userBadge = document.getElementById('userBadge');

const adminPanel = document.getElementById('adminPanel');
const routesList = document.getElementById('routesList');
const logsList = document.getElementById('logsList');
const addRouteBtn = document.getElementById('addRouteBtn');
const newRouteName = document.getElementById('newRouteName');
const newRouteFreq = document.getElementById('newRouteFreq');
const newRouteStops = document.getElementById('newRouteStops');
const refreshRoutesBtn = document.getElementById('refreshRoutesBtn');
const clearLogsBtn = document.getElementById('clearLogsBtn');
const exportLogsBtn = document.getElementById('exportLogsBtn');

/* -------------------------
   App state
------------------------- */
let CURRENT_USER = null;
let CURRENT_USER_IS_ADMIN = false;
let selectedRouteName = null;
let selectedRoute = null;
let useReverse = false;
let actualDepartureTime = null;
let currentStopIndex = 0;
let timerInterval = null;

/* -------------------------
   Utility
------------------------- */
function now(){ return new Date(); }
function formatTime(d){ return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }
function formatDiffSec(s){
  s = Math.floor(Math.abs(s));
  const mm = Math.floor(s/60).toString().padStart(2,'0');
  const ss = (s%60).toString().padStart(2,'0');
  return `${mm}:${ss}`;
}

/* -------------------------
   Login
------------------------- */
loginBtn.addEventListener('click', ()=>{
  const u=usernameEl.value.trim(), p=passwordEl.value;
  loginMsg.textContent='';
  if(!u||!p){ loginMsg.textContent='Enter username & password'; return;}
  const userRecord = USERS[u];
  if(!userRecord||userRecord.pw!==p){ loginMsg.textContent='Invalid username or password'; return;}
  CURRENT_USER = u;
  CURRENT_USER_IS_ADMIN = userRecord.admin;
  document.getElementById('loginSection').style.display='none';
  driverControls.style.display='block';
  logoutBtn.style.display='inline-block';
  userBadge.style.display='inline-block';
  userBadge.textContent = `${CURRENT_USER}${CURRENT_USER_IS_ADMIN?' (admin)':''}`;
  addActiveDriver(CURRENT_USER);
  populateRoutesSelect();
  if(CURRENT_USER_IS_ADMIN){ adminPanel.style.display='block'; populateAdminRoutes(); populateLogs(); }
});

logoutBtn.addEventListener('click', ()=>{
  CURRENT_USER=null; CURRENT_USER_IS_ADMIN=false;
  document.getElementById('loginSection').style.display='block';
  driverControls.style.display='none';
  adminPanel.style.display='none';
  timetableCard.style.display='none';
  stationControls.style.display='none';
  activeDriversDiv.style.display='none';
  logoutBtn.style.display='none';
  userBadge.style.display='none';
});

/* -------------------------
   Active Drivers
------------------------- */
let activeDrivers = [];
function addActiveDriver(name){
  if(!activeDrivers.includes(name)) activeDrivers.push(name);
  renderActiveDrivers();
}
function renderActiveDrivers(){
  driversList.innerHTML='';
  activeDrivers.forEach(d=>{
    const li=document.createElement('li'); li.textContent=d;
    driversList.appendChild(li);
  });
  activeDriversDiv.style.display = activeDrivers.length?'block':'none';
}

/* -------------------------
   Routes
------------------------- */
function populateRoutesSelect(){
  lineSelect.innerHTML='';
  const names = Object.keys(ROUTES).sort();
  names.forEach(n=>{
    const opt=document.createElement('option'); opt.value=n; opt.textContent=n;
    lineSelect.appendChild(opt);
  });
  if(names.length) lineSelect.value=names[0];
}

confirmBtn.addEventListener('click', ()=>{ selectedRouteName = lineSelect.value; useReverse=false; loadSelectedRoute(); });
reverseBtn.addEventListener('click', ()=>{
  if(!selectedRouteName) return;
  useReverse = !useReverse;
  loadSelectedRoute();
});

function loadSelectedRoute(){
  if(!selectedRouteName) return;
  let name = selectedRouteName;
  selectedRoute = ROUTES[name];
  if(useReverse){
    const revName = name.endsWith(' 2')? name.replace(/ 2$/,'') : name+' 2';
    if(ROUTES[revName]){ selectedRoute = ROUTES[revName]; name=revName; }
  }
  if(!selectedRoute) return;
  tableTitle.textContent = name;
  renderDynamicTimetable(selectedRoute, null);
  timetableCard.style.display='block';
  stationControls.style.display='block';
  clearTimer();
}

/* -------------------------
   Dynamic Timetable Render (+1 if late)
------------------------- */
function renderDynamicTimetable(route, departTime){
  tableBody.innerHTML='';
  route.stops.forEach((stop,i)=>{
    const tr=document.createElement('tr');
    const tdStop=document.createElement('td'); tdStop.textContent=stop.name||stop;
    const tdTime=document.createElement('td');
    if(departTime){
      const arrival = new Date(departTime.getTime()+i*60000);
      const diff = Math.floor((new Date() - arrival)/1000);
      tdTime.textContent = diff>60 ? '+1' : formatTime(arrival);
      if(diff>60) tdTime.style.color='#e43f5a';
    } else {
      tdTime.textContent = '--:--';
    }
    tr.appendChild(tdStop); tr.appendChild(tdTime);
    tableBody.appendChild(tr);
  });
}

/* -------------------------
   Timer & Depart Logic
------------------------- */
setInterval(()=>{
  const n=new Date(); 
  currentTime.textContent=n.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});
},1000);

departBtn.addEventListener('click', ()=>{
  if(!selectedRoute){ alert('Load a route'); return; }
  actualDepartureTime = new Date();
  currentStopIndex = 0;
  logShift(CURRENT_USER, tableTitle.textContent || lineSelect.value);
  renderDynamicTimetable(selectedRoute, actualDepartureTime);
  startStopTimerForIndex(currentStopIndex);
  statusDiv.textContent = `Departed: ${selectedRoute.stops[currentStopIndex].name}`;
});

nextBtn.addEventListener('click', ()=>{
  if(!selectedRoute || !actualDepartureTime) return;
  const arrival = new Date(actualDepartureTime.getTime() + currentStopIndex*60000);
  const diff = Math.floor((new Date() - arrival)/1000);
  if(diff<=0){
    statusDiv.innerHTML=`<span class="ok">On Time ✅</span> &nbsp;(${formatDiffSec(Math.abs(diff))})`;
  } else {
    statusDiv.innerHTML=`<span class="danger">Late ❌</span> &nbsp;(+${formatDiffSec(diff)})`;
  }
  currentStopIndex++;
  if(currentStopIndex>=selectedRoute.stops.length){ endRoute(); return; }
  startStopTimerForIndex(currentStopIndex);
});

endBtn.addEventListener('click', endRoute);

function startStopTimerForIndex(idx){
  clearTimer();
  timerInterval = setInterval(updateTimerDisplay,1000);
  updateTimerDisplay();
}

function updateTimerDisplay(){
  if(!selectedRoute || currentStopIndex>=selectedRoute.stops.length || !actualDepartureTime){
    timerDisplay.textContent='--:--'; nextBtn.disabled=true; return;
  }
  const expected = new Date(actualDepartureTime.getTime()+currentStopIndex*60000);
  const diffSec = Math.ceil((expected - new Date())/1000);
  if(diffSec>0){
    timerDisplay.style.background='var(--good)';
    timerDisplay.textContent=formatDiffSec(diffSec);
    nextBtn.disabled = diffSec>15;
  } else {
    timerDisplay.style.background='var(--bad)';
    timerDisplay.textContent='-'+formatDiffSec(Math.abs(diffSec));
    nextBtn.disabled=false;
  }
}

function clearTimer(){ if(timerInterval) clearInterval(timerInterval); timerInterval=null; timerDisplay.textContent='--:--'; nextBtn.disabled=true; }
function endRoute(){ clearTimer(); statusDiv.textContent='Route completed!'; currentStopIndex=0; actualDepartureTime=null; renderDynamicTimetable(selectedRoute, null); }

/* -------------------------
   Shift Logs
------------------------- */
function logShift(user, routeName){
  const entry={user,route:routeName,time:new Date().toISOString()};
  LOGS.unshift(entry);
  saveLogs(LOGS);
  if(CURRENT_USER_IS_ADMIN) populateLogs();
}

function populateLogs(){
  logsList.innerHTML='';
  if(!LOGS.length){ logsList.textContent='No shift logs'; return; }
  LOGS.forEach((l,idx)=>{
    const wrap=document.createElement('div'); wrap.className='logItem';
    const left=document.createElement('div'); 
    left.innerHTML=`<strong>${l.user}</strong> - ${l.route} <div class="mutedSmall">${new Date(l.time).toLocaleString()}</div>`;
    const right=document.createElement('div'); 
    const del=document.createElement('button'); del.className='smallBtn'; del.textContent='Delete';
    del.addEventListener('click', ()=>{ if(!confirm('Delete this log?')) return; LOGS.splice(idx,1); saveLogs(LOGS); populateLogs(); });
    right.appendChild(del); wrap.appendChild(left); wrap.appendChild(right); logsList.appendChild(wrap);
  });
}

/* -------------------------
   Admin: Routes
------------------------- */
function populateAdminRoutes(){
  routesList.innerHTML='';
  Object.keys(ROUTES).sort().forEach(n=>{
    const div=document.createElement('div'); div.style.display='flex'; div.style.justifyContent='space-between'; div.style.alignItems='center'; div.style.marginBottom='8px';
    const left=document.createElement('div'); left.innerHTML=`<strong>${n}</strong> <div class="mutedSmall">${ROUTES[n].freq} min — ${ROUTES[n].stops.length} stops</div>`;
    const right=document.createElement('div'); 
    const delBtn=document.createElement('button'); delBtn.className='smallBtn'; delBtn.textContent='Delete';
    delBtn.addEventListener('click', ()=>{ if(!confirm(`Delete route "${n}" and reverse?`)) return; deleteRouteAndReverse(n); populateAdminRoutes(); populateRoutesSelect(); });
    right.appendChild(delBtn); div.appendChild(left); div.appendChild(right); routesList.appendChild(div);
  });
}

addRouteBtn.addEventListener('click', ()=>{
  const name = newRouteName.value.trim();
  const freq = parseInt(newRouteFreq.value.trim());
  const stops = newRouteStops.value.split(/\n|,/).map(s=>s.trim()).filter(Boolean);
  if(!name || !freq || stops.length<2){ alert('Fill name, freq and at least 2 stops'); return; }
  ROUTES[name]={freq,stops};
  ROUTES[name+' 2']={freq,stops:[...stops].reverse()};
  saveRoutes(ROUTES); populateAdminRoutes(); populateRoutesSelect();
  newRouteName.value=''; newRouteFreq.value=''; newRouteStops.value='';
});

refreshRoutesBtn.addEventListener('click', populateAdminRoutes);
clearLogsBtn.addEventListener('click', ()=>{ if(confirm('Clear all logs?')){ LOGS=[]; saveLogs(LOGS); populateLogs(); } });
exportLogsBtn.addEventListener('click', ()=>{
  const data=JSON.stringify(LOGS,null,2); 
  const blob=new Blob([data],{type:'application/json'}); 
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='shift_logs.json'; a.click(); 
  URL.revokeObjectURL(url); 
});

function deleteRouteAndReverse(name){
  delete ROUTES[name];
  const revName = name.endsWith(' 2')? name.replace(/ 2$/,'') : name+' 2';
  if(ROUTES[revName]) delete ROUTES[revName];
  saveRoutes(ROUTES);
}
</script>
