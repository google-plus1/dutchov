<script>
/* -------------------------
   STORAGE KEYS & DEFAULTS
------------------------- */
const STORAGE_USERS = 'erlc_users_v3';
const STORAGE_ROUTES = 'erlc_routes_v3';
const STORAGE_LOGS = 'erlc_logs_v3';
const STORAGE_ACTIVE = 'erlc_activeDrivers_v3';
const STORAGE_STRIKES = 'erlc_strikes_v3';
const STORAGE_ROUTE_OWNERS = 'erlc_routeOwners_v3';

const defaultUsers = {
  "pwatg123admin": {pw:"utrechtov20092025", admin:true},
  "Roidkyadmin": {pw:"Mohamed4obai", admin:true},
  "Roidky": {pw:"Mohamed4obai", admin:false},
  "pwatg123": {pw:"utrechtov20092025", admin:false},
  "Ilias123": {pw:"Pass123", admin:false},
  "milandepro7": {pw:"Utrechtov20702025", admin:false},
  "blobvisje.": {pw:"pass123", admin:false}
};

const defaultRoutes = {
  "Lijn 6": {freq:10, stops:["Spawn","Fire Department","Central Park","P+R Transferium","Farms","Highrock"]},
  "Lijn 7 Shuttlebus": {freq:10, stops:["Spawn","Fire Department","Central Park","Hostpital"]},
  "Lijn 8 Shuttlebus": {freq:10, stops:["Spawn","Repair shop","P+R Transferium"]},
  "Lijn 9": {freq:10, stops:["Spawn","Chinatown","Fire Department","Central Park","Hospital","Farms","Highrock","Springfield"]},
  "FastLine": {freq:8, stops:["Springfield","River City"]}
};

/* -------------------------
   STORAGE HELPERS
------------------------- */
function save(key, value){ localStorage.setItem(key, JSON.stringify(value)); }
function load(key, fallback){ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }

let USERS = load(STORAGE_USERS, defaultUsers);
let ROUTES = load(STORAGE_ROUTES, null);
if(!ROUTES){
  ROUTES = JSON.parse(JSON.stringify(defaultRoutes));
  for(const name in defaultRoutes){
    const rev = name + " 2";
    if(!ROUTES[rev]) ROUTES[rev] = {freq: defaultRoutes[name].freq, stops: [...defaultRoutes[name].stops].reverse()};
  }
  save(STORAGE_ROUTES, ROUTES);
}
let LOGS = load(STORAGE_LOGS, []);
let ACTIVE_DRIVERS = load(STORAGE_ACTIVE, []);
let STRIKES = load(STORAGE_STRIKES, {});
let ROUTE_OWNERS = load(STORAGE_ROUTE_OWNERS, {});

/* -------------------------
   DOM ELEMENTS
------------------------- */
const usernameEl = document.getElementById('username');
const passwordEl = document.getElementById('password');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const loginMsg = document.getElementById('loginMsg');
const driverControls = document.getElementById('driverControls');
const userBadge = document.getElementById('userBadge');

const lineSelect = document.getElementById('lineSelect');
const confirmBtn = document.getElementById('confirmBtn');
const reverseBtn = document.getElementById('reverseBtn');

const timetableCard = document.getElementById('timetableCard');
const tableTitle = document.getElementById('tableTitle');
const tableBody = document.getElementById('tableBody');

const stationControls = document.getElementById('stationControls');
const departBtn = document.getElementById('departBtn');
const nextBtn = document.getElementById('nextBtn');
const endBtn = document.getElementById('endBtn');
const currentStationEl = document.getElementById('currentStation');
const timerDisplay = document.getElementById('timerDisplay');
const statusDiv = document.getElementById('status');

const adminPanel = document.getElementById('adminPanel');
const routesList = document.getElementById('routesList');
const logsList = document.getElementById('logsList');

const newRouteName = document.getElementById('newRouteName');
const newRouteFreq = document.getElementById('newRouteFreq');
const newRouteStops = document.getElementById('newRouteStops');
const addRouteBtn = document.getElementById('addRouteBtn');
const refreshRoutesBtn = document.getElementById('refreshRoutesBtn');

const newUsername = document.getElementById('newUsername');
const newPassword = document.getElementById('newPassword');
const createUserBtn = document.getElementById('createUserBtn');
const strikeSelect = document.getElementById('strikeSelect');
const strikeAmount = document.getElementById('strikeAmount');
const giveStrikeBtn = document.getElementById('giveStrikeBtn');

/* -------------------------
   STATE VARIABLES
------------------------- */
let CURRENT_USER = null;
let CURRENT_USER_IS_ADMIN = false;
let selectedRouteName = null;
let selectedRoute = null;
let useReverse = false;
let actualDepartureTime = null;
let currentStopIndex = 0;
let timerInterval = null;
let nextDepartureTimeForRoute = null;

/* -------------------------
   UTILITY FUNCTIONS
------------------------- */
function pad(n){ return String(n).padStart(2,'0'); }
function formatTime(d){ return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }
function formatTimeWithSeconds(d){ return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'}); }
function formatDiffSec(s){ s = Math.floor(Math.abs(s)); return `${pad(Math.floor(s/60))}:${pad(s%60)}`; }

/* -------------------------
   SAVE FUNCTIONS
------------------------- */
function saveUsers(){ save(STORAGE_USERS, USERS); populateAdminLists(); }
function saveRoutes(){ save(STORAGE_ROUTES, ROUTES); populateRoutesSelect(); populateAdminLists(); }
function saveLogs(){ save(STORAGE_LOGS, LOGS); renderLogs(); }
function saveActive(){ save(STORAGE_ACTIVE, ACTIVE_DRIVERS); renderActiveDrivers(); }
function saveStrikes(){ save(STORAGE_STRIKES, STRIKES); populateAdminLists(); }
function saveRouteOwners(){ save(STORAGE_ROUTE_OWNERS, ROUTE_OWNERS); }

/* -------------------------
   LOGIN / LOGOUT
------------------------- */
function renderActiveDrivers(){
  const list = document.getElementById("driversList");
  list.innerHTML = "";
  ACTIVE_DRIVERS.forEach(d=>{
    const li = document.createElement("li"); li.textContent = d; list.appendChild(li);
  });
  document.getElementById('activeDrivers').style.display = ACTIVE_DRIVERS.length ? 'block':'none';
}

loginBtn.addEventListener('click', ()=>{
  const u = usernameEl.value.trim();
  const p = passwordEl.value;
  loginMsg.textContent = '';
  if(!u||!p){ loginMsg.textContent='Enter username & password'; return; }
  const rec = USERS[u];
  if(!rec||rec.pw!==p){ loginMsg.textContent='Invalid username or password'; return; }

  CURRENT_USER = u; CURRENT_USER_IS_ADMIN = !!rec.admin;
  document.getElementById('loginSection').style.display='none';
  driverControls.style.display='block';
  logoutBtn.style.display='inline-block';
  userBadge.style.display='inline-block';
  userBadge.textContent = `${CURRENT_USER}${CURRENT_USER_IS_ADMIN?' (admin)':''}`;

  if(!ACTIVE_DRIVERS.includes(CURRENT_USER)){ ACTIVE_DRIVERS.push(CURRENT_USER); saveActive(); }

  populateRoutesSelect();
  populateAdminLists();
});

logoutBtn.addEventListener('click', ()=>{
  if(CURRENT_USER){
    const idx = ACTIVE_DRIVERS.indexOf(CURRENT_USER);
    if(idx!==-1){ ACTIVE_DRIVERS.splice(idx,1); saveActive(); }
    for(const r in ROUTE_OWNERS){ if(ROUTE_OWNERS[r]===CURRENT_USER){ delete ROUTE_OWNERS[r]; } }
    saveRouteOwners();
  }
  CURRENT_USER=null; CURRENT_USER_IS_ADMIN=false;
  document.getElementById('loginSection').style.display='block';
  driverControls.style.display='none';
  adminPanel.style.display='none';
  timetableCard.style.display='none';
  stationControls.style.display='none';
  logoutBtn.style.display='none';
  userBadge.style.display='none';
});

/* -------------------------
   ROUTE SELECT / TIMETABLE
------------------------- */
function populateRoutesSelect(){
  lineSelect.innerHTML='';
  Object.keys(ROUTES).sort().forEach(n=>{
    const opt=document.createElement('option'); opt.value=n; opt.textContent=n; lineSelect.appendChild(opt);
  });
  if(lineSelect.options.length) lineSelect.value=lineSelect.options[0].value;
}

function populateAdminLists(){
  routesList.innerHTML='';
  Object.keys(ROUTES).sort().forEach(name=>{
    const div=document.createElement('div'); div.style.display='flex'; div.style.justifyContent='space-between'; div.style.alignItems='center'; div.style.marginBottom='8px';
    const left=document.createElement('div'); left.innerHTML=`<strong>${name}</strong> <div class="mutedSmall">${ROUTES[name].freq} min â€” ${ROUTES[name].stops.length} stops</div>`;
    const right=document.createElement('div');

    const editBtn = document.createElement('button'); editBtn.className='smallBtn'; editBtn.textContent='Edit';
    editBtn.addEventListener('click', ()=>{
      const newName=prompt('New route name:', name) || name;
      const newFreq=parseInt(prompt('New frequency (minutes):', ROUTES[name].freq) || ROUTES[name].freq,10);
      const newStops=prompt('Stops (comma or newline separated):', ROUTES[name].stops.join(','))?.split(/\r?\n|,/).map(s=>s.trim()).filter(Boolean);
      if(!newStops || newStops.length<2){ alert('Need at least 2 stops'); return; }
      delete ROUTES[name]; delete ROUTES[name+' 2'];
      ROUTES[newName]={freq:newFreq, stops:newStops};
      ROUTES[newName+' 2']={freq:newFreq, stops:[...newStops].reverse()};
      saveRoutes();
    });

    const delBtn = document.createElement('button'); delBtn.className='smallBtn'; delBtn.textContent='Delete';
    delBtn.addEventListener('click', ()=>{
      if(confirm(`Delete route "${name}" and its reverse?`)){ delete ROUTES[name]; delete ROUTES[name+' 2']; saveRoutes(); }
    });

    right.appendChild(editBtn); right.appendChild(delBtn);
    div.appendChild(left); div.appendChild(right);
    routesList.appendChild(div);
  });

  strikeSelect.innerHTML='';
  Object.keys(USERS).sort().forEach(u=>{
    const opt=document.createElement('option'); opt.value=u; opt.textContent=u; strikeSelect.appendChild(opt);
  });

  renderLogs();
}

/* -------------------------
   STRIKE SYSTEM
------------------------- */
giveStrikeBtn.addEventListener('click', ()=>{
  const u = strikeSelect.value;
  const amt = parseInt(strikeAmount.value || '1',10);
  if(!u) return alert('Select user');
  STRIKES[u]=(STRIKES[u]||0)+amt; saveStrikes();
  alert(`Gave ${amt} strike(s) to ${u}. Total: ${STRIKES[u]}`);
});

function removeStrike(user){
  if(!STRIKES[user]) return alert(`${user} has no strikes`);
  STRIKES[user]=Math.max(0, STRIKES[user]-1);
  saveStrikes();
  alert(`Removed 1 strike from ${user}. Total: ${STRIKES[user]}`);
}

/* -------------------------
   LOGS
------------------------- */
function renderLogs(){
  logsList.innerHTML='';
  if(!LOGS.length){ logsList.textContent='No shift logs'; return; }
  LOGS.forEach((l,idx)=>{
    const wrap=document.createElement('div'); wrap.className='logItem';
    const left=document.createElement('div'); left.innerHTML=`<strong>${l.user}</strong> - ${l.route} <div class="mutedSmall">${new Date(l.time).toLocaleString()}</div>`;
    const right=document.createElement('div');
    const delBtn=document.createElement('button'); delBtn.className='smallBtn'; delBtn.textContent='Delete';
    delBtn.addEventListener('click', ()=>{
      if(confirm('Delete this log?')){ LOGS.splice(idx,1); saveLogs(); }
    });
    right.appendChild(delBtn); wrap.appendChild(left); wrap.appendChild(right);
    logsList.appendChild(wrap);
  });
}

/* -------------------------
   INIT UI
------------------------- */
function initUI(){
  populateRoutesSelect();
  populateAdminLists();
  renderActiveDrivers();
  renderLogs();
}
initUI();
</script>
