<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>OVS</title>
<style>
:root{
  --bg:#0f1724;
  --card:#0b1220;
  --accent:#ff6b6b;
  --muted:#9aa4c0;
  --good:#1cc88a;
  --bad:#e43f5a;
  --panel:#0f3460;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
  background:linear-gradient(180deg,#071024 0%, #0e1530 100%);
  color:#edf2f7;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}
header{
  padding:18px 24px;
  border-bottom:1px solid rgba(255,255,255,.03);
  display:flex;
  align-items:center;
  gap:12px
}
h1{margin:0;font-size:18px}
.wrap{display:flex;gap:20px;padding:20px;max-width:1200px;margin:20px auto}
.card{background:var(--card);border-radius:12px;padding:18px;width:360px;box-shadow:0 6px 30px rgba(2,6,23,.6)}
.wide{flex:1;min-width:360px;padding:18px}
label{display:block;font-size:13px;color:var(--muted);margin-top:8px}
input,select,textarea,button{width:100%;padding:10px;border-radius:8px;border:0;font-size:14px}
textarea{min-height:88px;resize:vertical}
button{background:var(--accent);color:#fff;border:0;cursor:pointer}
.muted{color:var(--muted);font-size:13px}
.infoRow{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:10px}
.big{font-weight:700;font-size:18px}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,.03);font-size:14px}
th{color:#fff;background:linear-gradient(90deg,var(--accent),#ff907a);border-radius:6px}
.smallBtn{padding:6px 8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,.06);color:var(--muted);cursor:pointer}
#activeDrivers{position:fixed;left:18px;bottom:18px;background:var(--panel);padding:12px;border-radius:10px;min-width:200px;box-shadow:0 8px 30px rgba(0,0,0,.6)}
#activeDrivers h3{margin:0 0 6px 0;color:var(--good);font-size:14px}
.timer{margin-top:12px;padding:10px;border-radius:8px;text-align:center;font-weight:700;font-size:20px;color:#fff;background:var(--good);min-width:120px}
.status{margin-top:8px;font-weight:600}
.adminPanel{background:#07183a;padding:12px;border-radius:10px}
.row{display:flex;gap:8px}
.row > *{flex:1}
.mutedSmall{font-size:12px;color:var(--muted)}
.logItem{display:flex;justify-content:space-between;gap:10px;align-items:center;padding:8px;border-radius:6px;background:rgba(255,255,255,.02);margin-bottom:8px}
.danger{background:rgba(228,63,90,.08);border:1px solid rgba(228,63,90,.12);color:var(--bad);padding:6px 8px;border-radius:8px}
.ok{background:rgba(28,200,138,.06);border:1px solid rgba(28,200,138,.12);color:var(--good);padding:6px 8px;border-radius:8px}
.inlineSmall{display:inline-block;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,.02);color:var(--muted);font-size:13px}
</style>
</head>
<body>
<header>
  <h1>Openbaar Vervoer systeem</h1>
  <div style="margin-left:auto" class="mutedSmall">Local demo â€” data saved in browser storage</div>
</header>
<div class="wrap">
  <!-- Left column -->
  <div class="card">
    <div id="loginSection">
      <h2 style="margin:0 0 8px 0">Login</h2>
      <label>Username</label>
      <input id="username" placeholder="username" />
      <label>Password</label>
      <input id="password" type="password" placeholder="password" />
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="loginBtn">Login</button>
        <button id="logoutBtn" style="display:none;background:#6c757d">Logout</button>
      </div>
      <div id="loginMsg" class="mutedSmall" style="margin-top:8px;color:#ffb4b4"></div>
    </div>
    <div id="driverControls" style="display:none;margin-top:12px">
      <h3 style="margin:0 0 8px 0">Driver Controls</h3>
      <label>Choose Line</label>
      <select id="lineSelect"></select>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="confirmBtn">Load Timetable</button>
        <button id="reverseBtn" title="Toggle original/return" class="smallBtn">Reverse</button>
      </div>
      <div class="infoRow">
        <div>
          <div class="mutedSmall">Current time</div>
          <div id="currentTime" class="big"></div>
        </div>
        <div style="text-align:right">
          <div class="mutedSmall">Next departure</div>
          <div id="nextDeparture" class="big">--:--</div>
        </div>
      </div>
      <div style="margin-top:10px">
        <div class="mutedSmall">Countdown to next departure</div>
        <div id="countdown" class="timer">--:--</div>
      </div>
      <div id="stationControls" style="display:none;margin-top:12px">
        <div style="display:flex;gap:8px">
          <button id="departBtn">Vertrek</button>
          <button id="nextBtn" disabled>Volgende halte</button>
          <button id="endBtn">Einde</button>
        </div>
        <div id="currentStation" class="status" style="margin-top:6px"></div>
        <div id="timerDisplay" class="timer" style="margin-top:10px;background:var(--good)">--:--</div>
        <div id="status" class="status mutedSmall"></div>
        <div style="margin-top:8px" class="mutedSmall">*Next Station button only in last 15s before arrival or when late.</div>
      </div>
    </div>
  </div>
  <!-- Middle column -->
  <div class="wide card" style="min-width:520px">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2 style="margin:0">Paneel</h2>
      <div id="userBadge" class="inlineSmall" style="display:none"></div>
    </div>
    <div id="timetableCard" style="margin-top:12px; display:none">
      <div class="mutedSmall">Timetable for <strong id="tableTitle"></strong></div>
      <table id="timetableTable">
        <thead><tr><th>Stop</th><th>Arrival</th></tr></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
    <div id="adminPanel" style="margin-top:16px;display:none" class="adminPanel">
      <h3 style="margin:0 0 8px 0;color:var(--good)">Admin Panel</h3>
      <div style="display:flex;gap:10px">
        <div style="flex:1">
          <label>New Route name</label>
          <input id="newRouteName" placeholder="e.g. Lijn X" />
          <label>Frequency (minutes)</label>
          <input id="newRouteFreq" placeholder="10" />
          <label>Stops (one per line or comma separated)</label>
          <textarea id="newRouteStops" placeholder="Spawn&#10;Chinatown&#10;Fire Department"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="addRouteBtn">Add Route</button>
            <button id="refreshRoutesBtn" class="smallBtn">Refresh</button>
          </div>
          <hr style="border:none;border-top:1px solid rgba(255,255,255,.03);margin:12px 0">
          <label>Create User</label>
          <input id="newUsername" placeholder="username">
          <input id="newPassword" type="password" placeholder="password">
          <button id="createUserBtn" style="margin-top:6px">Create User</button>
          <label style="margin-top:10px">Give Strikes</label>
          <select id="strikeSelect"></select>
          <input id="strikeAmount" placeholder="Number of strikes" type="number">
          <button id="giveStrikeBtn" style="margin-top:6px">Give Strike</button>
        </div>
        <div style="width:260px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="mutedSmall">Routes</div>
            <div class="mutedSmall">Actions</div>
          </div>
          <div id="routesList" style="margin-top:8px;max-height:280px;overflow:auto"></div>
          <div style="margin-top:12px" class="mutedSmall">Shift Logs</div>
          <div id="logsList" style="margin-top:8px;max-height:220px;overflow:auto"></div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Active drivers -->
<div id="activeDrivers" style="display:none">
  <h3>Active Drivers</h3>
  <ul id="driversList" style="margin:0;padding-left:18px"></ul>
</div>

<script>
// ------------------------- Data & Storage -------------------------
const STORAGE_USERS = 'erlc_users_v4';
const STORAGE_ROUTES = 'erlc_routes_v4';
const STORAGE_LOGS = 'erlc_logs_v4';
const STORAGE_ACTIVE = 'erlc_activeDrivers_v4';
const STORAGE_STRIKES = 'erlc_strikes_v4';
const STORAGE_ROUTE_OWNERS = 'erlc_routeOwners_v4';

const defaultUsers = {
  "pwatg123admin": {pw:"utrechtov20092025", admin:true},
  "Roidkyadmin": {pw:"Mohamed4obai", admin:true},
  "Roidky": {pw:"Mohamed4obai", admin:false},
  "pwatg123": {pw:"utrechtov20092025", admin:false},
  "Ilias123": {pw:"Pass123", admin:false},
  "milandepro7": {pw:"Utrechtov20702025", admin:false},
  "blobvisje.": {pw:"pass123", admin:false}
};

const defaultRoutes = {
  "Lijn 6": {freq:10, stops:["Spawn","Fire Department","Central Park","P+R Transferium","Farms","Highrock"]},
  "Lijn 7 Shuttlebus": {freq:10, stops:["Spawn","Fire Department","Central Park","Hostpital"]},
  "Lijn 8 Shuttlebus": {freq:10, stops:["Spawn","Repair shop","P+R Transferium"]},
  "Lijn 9": {freq:10, stops:["Spawn","Chinatown","Fire Department","Central Park","Hospital","Farms","Highrock","Springfield"]},
  "FastLine": {freq:8, stops:["Springfield","River City"]}
};

// Load/Save helpers
function load(key,fallback){return JSON.parse(localStorage.getItem(key)||JSON.stringify(fallback));}
function save(key,val){localStorage.setItem(key,JSON.stringify(val));}

let USERS = load(STORAGE_USERS, defaultUsers);
let ROUTES = load(STORAGE_ROUTES, defaultRoutes);
let LOGS = load(STORAGE_LOGS, []);
let ACTIVE_DRIVERS = load(STORAGE_ACTIVE, []);
let STRIKES = load(STORAGE_STRIKES, {});
let ROUTE_OWNERS = load(STORAGE_ROUTE_OWNERS,{});

// ------------------------- Elements -------------------------
const usernameEl = document.getElementById('username');
const passwordEl = document.getElementById('password');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const loginMsg = document.getElementById('loginMsg');
const driverControls = document.getElementById('driverControls');
const userBadge = document.getElementById('userBadge');
const lineSelect = document.getElementById('lineSelect');
const confirmBtn = document.getElementById('confirmBtn');
const reverseBtn = document.getElementById('reverseBtn');
const currentTimeEl = document.getElementById('currentTime');
const nextDepartureEl = document.getElementById('nextDeparture');
const countdownEl = document.getElementById('countdown');
const stationControls = document.getElementById('stationControls');
const departBtn = document.getElementById('departBtn');
const nextBtn = document.getElementById('nextBtn');
const endBtn = document.getElementById('endBtn');
const currentStationEl = document.getElementById('currentStation');
const timerDisplay = document.getElementById('timerDisplay');
const statusDiv = document.getElementById('status');
const timetableCard = document.getElementById('timetableCard');
const tableTitle = document.getElementById('tableTitle');
const tableBody = document.getElementById('tableBody');
const adminPanel = document.getElementById('adminPanel');
const routesList = document.getElementById('routesList');
const logsList = document.getElementById('logsList');
const newUsername = document.getElementById('newUsername');
const newPassword = document.getElementById('newPassword');
const createUserBtn = document.getElementById('createUserBtn');
const strikeSelect = document.getElementById('strikeSelect');
const strikeAmount = document.getElementById('strikeAmount');
const giveStrikeBtn = document.getElementById('giveStrikeBtn');
const newRouteName = document.getElementById('newRouteName');
const newRouteFreq = document.getElementById('newRouteFreq');
const newRouteStops = document.getElementById('newRouteStops');
const addRouteBtn = document.getElementById('addRouteBtn');
const refreshRoutesBtn = document.getElementById('refreshRoutesBtn');
const driversList = document.getElementById('driversList');
const activeDriversDiv = document.getElementById('activeDrivers');

// ------------------------- App State -------------------------
let CURRENT_USER = null;
let CURRENT_USER_IS_ADMIN = false;
let selectedRouteName = null;
let selectedRoute = null;
let useReverse = false;
let actualDepartureTime = null;
let currentStopIndex = 0;
let timerInterval = null;
let nextDepartureTimeForRoute = null;

// ========================== LOGIN / LOGOUT ==========================
loginBtn.addEventListener('click',()=> {
  const u=usernameEl.value.trim(),p=passwordEl.value;
  loginMsg.textContent="";
  if(!u||!p){loginMsg.textContent="Enter username & password";return;}
  const rec=USERS[u];if(!rec||rec.pw!==p){loginMsg.textContent="Invalid username or password";return;}
  CURRENT_USER=u;CURRENT_USER_IS_ADMIN=!!rec.admin;
  document.getElementById('loginSection').style.display='none';
  driverControls.style.display='block';
  logoutBtn.style.display='inline-block';
  userBadge.style.display='inline-block';
  userBadge.textContent=`${CURRENT_USER}${CURRENT_USER_IS_ADMIN?" (admin)":""}`;
  if(!ACTIVE_DRIVERS.includes(CURRENT_USER)){ACTIVE_DRIVERS.push(CURRENT_USER); save(STORAGE_ACTIVE,ACTIVE_DRIVERS);}
  populateRoutesSelect();
  populateAdminLists();
});

logoutBtn.addEventListener('click',()=> {
  if(CURRENT_USER){
    ACTIVE_DRIVERS=ACTIVE_DRIVERS.filter(n=>n!==CURRENT_USER);
    save(STORAGE_ACTIVE,ACTIVE_DRIVERS);
    for(const r in ROUTE_OWNERS){if(ROUTE_OWNERS[r]===CURRENT_USER) delete ROUTE_OWNERS[r];}
    save(STORAGE_ROUTE_OWNERS,ROUTE_OWNERS);
  }
  CURRENT_USER=null;
  CURRENT_USER_IS_ADMIN=false;
  document.getElementById('loginSection').style.display='block';
  driverControls.style.display='none';
  logoutBtn.style.display='none';
  userBadge.style.display='none';
  usernameEl.value=""; passwordEl.value="";
});

// ------------------------- UI INIT -------------------------
function populateRoutesSelect(){
  lineSelect.innerHTML='';
  Object.keys(ROUTES).sort().forEach(n=>{
    const opt=document.createElement('option');opt.value=n;opt.textContent=n;lineSelect.appendChild(opt);
  });
  if(lineSelect.options.length) lineSelect.value=lineSelect.options[0].value;
}

function populateAdminLists(){
  // routes
  routesList.innerHTML='';
  Object.keys(ROUTES).sort().forEach(name=>{
    const div=document.createElement('div');div.style.display='flex';div.style.justifyContent='space-between';div.style.alignItems='center';
    const left=document.createElement('div');left.textContent=name;
    const right=document.createElement('div');
    const delBtn=document.createElement('button');delBtn.textContent='X';delBtn.className='smallBtn';
    delBtn.onclick=()=>{if(confirm(`Delete route ${name}?`)){delete ROUTES[name]; save(STORAGE_ROUTES,ROUTES);populateAdminLists();populateRoutesSelect();}};
    right.appendChild(delBtn);div.appendChild(left);div.appendChild(right);routesList.appendChild(div);
  });
  // logs
  logsList.innerHTML='';
  LOGS.slice().reverse().forEach(log=>{
    const div=document.createElement('div');div.className='logItem';div.innerHTML=`<span>${log.user}</span><span>${log.msg}</span>`;logsList.appendChild(div);
  });
  // strikes
  strikeSelect.innerHTML='';
  Object.keys(USERS).sort().forEach(u=>{
    const opt=document.createElement('option');opt.value=u;opt.textContent=u;strikeSelect.appendChild(opt);
  });
  adminPanel.style.display=CURRENT_USER_IS_ADMIN?'block':'none';
  activeDriversDiv.style.display=ACTIVE_DRIVERS.length?'block':'none';
  updateActiveDriversList();
}

function updateActiveDriversList(){
  driversList.innerHTML='';
  ACTIVE_DRIVERS.forEach(d=>{
    const li=document.createElement('li');li.textContent=d;driversList.appendChild(li);
  });
  activeDriversDiv.style.display=ACTIVE_DRIVERS.length?'block':'none';
}

// ------------------------- TIMETABLE / COUNTDOWN -------------------------
function updateTimeDisplays(){
  const now=new Date();
  currentTimeEl.textContent=now.toLocaleTimeString();
  if(nextDepartureTimeForRoute){
    const diff=Math.floor((nextDepartureTimeForRoute-now)/1000);
    countdownEl.textContent=diff>0?`${Math.floor(diff/60).toString().padStart(2,'0')}:${(diff%60).toString().padStart(2,'0')}`:'00:00';
  }else{countdownEl.textContent='--:--';}
}
setInterval(updateTimeDisplays,1000);

// ------------------------- TIMETABLE LOAD -------------------------
confirmBtn.addEventListener('click',()=>loadRoute());
reverseBtn.addEventListener('click',()=>{useReverse=!useReverse;loadRoute();});

function loadRoute(){
  selectedRouteName=lineSelect.value;
  selectedRoute=ROUTES[selectedRouteName];
  if(!selectedRoute) return;
  // setup table
  tableTitle.textContent=selectedRouteName;
  tableBody.innerHTML='';
  const stops = useReverse?[...selectedRoute.stops].reverse():selectedRoute.stops;
  stops.forEach(s=>{
    const tr=document.createElement('tr');tr.innerHTML=`<td>${s}</td><td>--:--</td>`;tableBody.appendChild(tr);
  });
  timetableCard.style.display='block';
  currentStopIndex=0;
  stationControls.style.display='block';
  actualDepartureTime=new Date();
  nextDepartureTimeForRoute=new Date(Date.now()+selectedRoute.freq*60000);
  updateTimeDisplays();
}

// ------------------------- STATION CONTROL BUTTONS -------------------------
departBtn.addEventListener('click',()=>{if(currentStopIndex<selectedRoute.stops.length){currentStationEl.textContent=selectedRoute.stops[currentStopIndex];statusDiv.textContent='En route...';nextBtn.disabled=false;}});
nextBtn.addEventListener('click',()=>{currentStopIndex++; if(currentStopIndex>=selectedRoute.stops.length){statusDiv.textContent='End of route';nextBtn.disabled=true;}else{currentStationEl.textContent=selectedRoute.stops[currentStopIndex];}});
endBtn.addEventListener('click',()=>{currentStopIndex=0;currentStationEl.textContent='';statusDiv.textContent='Route ended';stationControls.style.display='none';});

// ------------------------- ADMIN BUTTONS -------------------------
createUserBtn.addEventListener('click',()=>{
  const u=newUsername.value.trim(),p=newPassword.value;
  if(!u||!p){alert('Enter username & password');return;}
  if(USERS[u]){alert('User exists');return;}
  USERS[u]={pw:p,admin:false}; save(STORAGE_USERS,USERS); populateAdminLists(); alert('User created');
  newUsername.value=''; newPassword.value='';
});

giveStrikeBtn.addEventListener('click',()=>{
  const u=strikeSelect.value; const n=parseInt(strikeAmount.value)||0;
  if(n<=0){alert('Enter strike amount'); return;}
  STRIKES[u]=(STRIKES[u]||0)+n; save(STORAGE_STRIKES,STRIKES); alert(`Gave ${n} strike(s) to ${u}`); strikeAmount.value='';
});

addRouteBtn.addEventListener('click',()=>{
  const n=newRouteName.value.trim(); const f=parseInt(newRouteFreq.value); const stops=newRouteStops.value.split(/[\n,]+/).map(x=>x.trim()).filter(Boolean);
  if(!n||!f||stops.length<1){alert('Enter valid route info');return;}
  ROUTES[n]={freq:f,stops:stops}; save(STORAGE_ROUTES,ROUTES); populateRoutesSelect(); populateAdminLists(); newRouteName.value=''; newRouteFreq.value=''; newRouteStops.value='';
});

refreshRoutesBtn.addEventListener('click',()=>{populateRoutesSelect(); populateAdminLists();});

// ------------------------- INIT -------------------------
populateRoutesSelect();
populateAdminLists();
</script>
</body>
</html>
